> åŸæ–‡é“¾æ¥: https://www.anquanke.com//post/id/247830 


# CVE-2021-22555 linuxå†…æ ¸ææƒ


                                é˜…è¯»é‡ Â Â 
                                **26576**
                            
                        |
                        
                                                                                    



[![](https://p0.ssl.qhimg.com/t01f7388b670970ced8.jpg)](https://p0.ssl.qhimg.com/t01f7388b670970ced8.jpg)



è¯¥æ¼æ´ä½œè€…Andy Nguyen (theflow@) ï¼Œwriteupå·²ç»å…¬å¼€ã€‚

## ç®€å•æ¦‚è¿°

ä¸»è¦æ˜¯åœ¨`xt_compat_target_from_user()`ä¸­æœ‰æº¢å‡ºï¼Œç»è¿‡ç‰¹æ®Šæ„é€ äº§ç”Ÿuafï¼Œ

å…·ä½“expä¸­ï¼Œä½¿ç”¨äº†`struct msg_msg`ä½œä¸ºæº¢å‡ºï¼Œå¯¼è‡´ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªchunkï¼Œä½¿ç”¨å¥—æ¥å­—ç®€åŒ–äº†uafçš„ä½¿ç”¨æµç¨‹ï¼Œæœ€ååˆ©ç”¨pipe()ç®¡é“ä¸­çš„`struct pipe_buf_operations` æ¥æ³„éœ²åœ°å€ï¼Œä»¥åŠä¼ªé€ ä¿®æ”¹å…³é—­pipesæ—¶è°ƒç”¨çš„`release` å‡½æ•°åœ°å€è°ƒç”¨ropé“¾ï¼Œå®Œæˆæƒé™æå‡ä»¥åŠè¿”å›ç”¨æˆ·ç©ºé—´



## ä¿®è¡¥æ–¹æ¡ˆ

åœ¨æŸ¥è¯¢æºä»£ç è¿‡ç¨‹ä¸­å‘ç°æŸäº›ç‰ˆæœ¬çš„ä»£ç ä¸­é€‰æ‹©å°†`xt_compat_target_from_user()`çš„æ¼æ´è§¦å‘ä»£ç åˆ é™¤ï¼ˆç®€å•æ˜äº†ï¼‰



## æ¼æ´å…·ä½“åˆ†æ

åœ¨å…¼å®¹æ¨¡å¼ä¸‹ï¼Œå³å­˜åœ¨#`define CONFIG_COMPAT`æ¡ä»¶ä¸‹

å¥—æ¥å­— `IPT_SO_SET_REPLACE` æˆ–è€…`IP6T_SO_SET_REPLACE`è¢«è°ƒç”¨ï¼Œ

åœ¨`xt_compat_target_from_user()`ä¸­`memset()`å‚æ•°`target-&gt;targetsize`æ²¡æœ‰æ£€æŸ¥åç§»ï¼Œå¯¼è‡´å¯èƒ½å‡ºç°å­—èŠ‚è¶Šç•Œã€‚

```
#ifdef CONFIG_COMPAT
int xt_compat_target_offset(struct xt_target *target)
`{`
    u_int16_t csize = target-&gt;compatsize ? : target-&gt;targetsize;
    return XT_ALIGN(target-&gt;targetsize) - COMPAT_XT_ALIGN(csize);
`}`
EXPORT_SYMBOL_GPL(xt_compat_target_offset);

void xt_compat_target_from_user(struct xt_entry_target *t, void **dstptr, int *size)
`{`                    //t è¡¨ç¤ºç”¨æˆ·æˆ–è€…å†…æ ¸çš„target_size target_name
                    //
    struct xt_target *target = t-&gt;u.kernel.target;//å†…æ ¸target å¯¹åº”struct xt_target å³targetåŸºæœ¬ç±»å‹
    struct compat_xt_entry_target *ct = (struct compat_xt_entry_target *)t; //xt = tçš„å‰¯æœ¬
    int pad, off = xt_compat_target_offset(target);
    u_int16_t tsize = ct-&gt;u.user.target_size;

    t = *dstptr;
    memcpy(t, ct, sizeof(*ct));//å°†ctè¦†ç›–åˆ°dst
    //å½“å†…æ ¸åç§»ä¸ç”¨æˆ·æ€åç§»ä¸åŒæ—¶ä½¿ç”¨
    if (target-&gt;compat_from_user)
        target-&gt;compat_from_user(t-&gt;data, ct-&gt;data);
    else
        memcpy(t-&gt;data, ct-&gt;data, tsize - sizeof(*ct));
    pad = XT_ALIGN(target-&gt;targetsize) - target-&gt;targetsize;
    //æ¼æ´è§¦å‘ç‚¹
    if (pad &gt; 0)
        memset(t-&gt;data + target-&gt;targetsize, 0, pad);//æœ«ä½è¡¥0ï¼Œæ§åˆ¶target-&gt;targetsizeåå¤§ï¼Œå¯ä»¥é€ æˆ\x00æº¢å‡º
    //è¿™é‡Œæœ‰è¶Šç•Œ off by null è®¾ç½®åç§»
    tsize += off;
    t-&gt;u.user.target_size = tsize;

    *size += off;
    *dstptr += tsize;
`}`
```

`target-&gt;targetsize`ä¸ç”±ç”¨æˆ·æ§åˆ¶ï¼Œå¯ä»¥é€šè¿‡é€‰æ‹©ä¸åŒå¤§å°çš„targetç±»å‹ç»“æ„ä½“æ¥æ§åˆ¶targetsizeå¤§å°ã€‚



## å¦‚ä½•è§¦å‘æ¼æ´ï¼Ÿ

æ¼æ´æˆå›  åœ¨`xt_compat_target_from_user()`ä¸­`memset()`å‚æ•°`target-&gt;targetsize` æº¢å‡ºå¯¼è‡´

```
memset(t-&gt;data + target-&gt;targetsize, 0, pad);
```

åŸæœ¬ç›®çš„åº”è¯¥æ˜¯å°†æœªæ»¡è¶³çš„åç§»å¡«å……0ã€‚targetsizeä¸è¢«ç”¨æˆ·ç›´æ¥æ§åˆ¶ï¼Œå¯ä»¥é€šè¿‡é€‰æ‹©ä¸åŒçš„targetç±»å‹ï¼Œä½†æ˜¯targetsizeä¸èƒ½æ˜¯8ä½åç§»æ•´é½ï¼Œæ»¡è¶³`pad&gt;0`,

æ„é€ æ•°æ®dataï¼Œé€šè¿‡æ§åˆ¶padã€‚æ§åˆ¶æº¢å‡ºæ•°é‡ã€‚

expåˆ©ç”¨æ—¶ï¼Œé€‰æ‹©åˆ›å»ºdataæ•°æ®ï¼Œdateæ•°æ®é•¿åº¦ä¸º0x1012ã€‚è¿™æ ·åˆšå¥½è¦†ç›–åˆ°æ¥ä¸‹æ¥ç”³è¯·0x1000å¤§å°å †å—çš„å¯¹åº”ç»“æ„ä½“çš„æŒ‡é’ˆå2bitï¼Œé€ æˆæŒ‡é’ˆçš„æŒ‡å‘é”™è¯¯ã€‚



## å…·ä½“å®ç° uaf

ç”±äºåœ¨å†…æ ¸ä¸­æ— æ³•ç›´æ¥ç”³è¯·å›ºå®šå¤§å°å †å—ï¼Œexpé€‰æ‹©ä½¿ç”¨åˆ›å»º`msg_msg`ç»“æ„ä½“ï¼Œ

msgsend()å†…éƒ¨ä½¿ç”¨alloc_msg(),

alloc_msgå°†ä¸€å®šé•¿åº¦çš„msgåˆ©ç”¨kmallocå¤šæ¬¡åˆ†é…æ¯ä¸€æ®µmsgå¼€å¤´éƒ½æœ‰msg_msgç»“æ„ä½“

```
/* one msg_msg structure for each message */
struct msg_msg `{`
    struct list_head m_list;/*é“¾è¡¨å¤´*/
    long m_type; /*ç±»å‹*/
    size_t m_ts;        /* message text size */
    struct msg_msgseg *next;
    void *security;
    /* the actual message follows immediately */
`}`;
//æŠŠidå–å‡ºæ¥
struct list_head `{`
    struct list_head *next, *prev;
`}`;

struct msg_msgseg `{`
    struct msg_msgseg *next;
    /* the next part of the message follows immediately */
`}`;
```

`msgget()`é¦–å…ˆåˆ›å»º4096ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¹æ¯ä¸€ä¸ªé˜Ÿåˆ—å…ˆå‘é€msg_primary,å¤§å°ä¸º0x1000ï¼Œå†å¯¹æ¯ä¸€é˜Ÿåˆ—å‘é€msg_secondary,å¤§å°ä¸º0x400ï¼Œè¿™æ ·å¯¹äºæ¯ä¸€ä¸ªé˜Ÿåˆ—ä¸­éƒ½æœ‰ä¸¤æ¡æ¶ˆæ¯ï¼Œåˆ†åˆ«å¯¹åº”0x1000 å’Œ0x400å¤§å°çš„chunkï¼Œå¹¶ä¸”åˆ†åˆ«å¯¹æ¯ä¸€ä¸ªmsgè¿›è¡Œæ ‡å·ï¼Œä½¿msgå†…éƒ¨å­˜æœ‰å¯¹åº”msgæ ‡å·ï¼Œ`struct msg_msg`ä½äºæ•´ä¸ªchunkçš„å¤´éƒ¨ï¼Œ

ä»¥ä¸Šæ˜¯åŸºç¡€chunkçš„æ„é€ 

é€šè¿‡è¯»å–msgï¼Œå°†å¯¹åº”chunké‡Šæ”¾ï¼Œç”±äºé‡Šæ”¾çš„æ˜¯0x1000å¤§å°ï¼Œä½¿ç”¨è§¦å‘æ¼æ´ï¼Œå°†ä¸‹ä¸€ä¸ªå †å—`msg_msg`çš„`struct list_head`çš„åä¸¤ä½æº¢å‡ºä¸º0ï¼Œå¦‚æœæ­£ç¡®è¿è¡Œï¼ŒæˆåŠŸå°†ä¸€ä¸ªprimary_msgå¯¹åº”çš„secondary_msgæŒ‡å‘ä¸å±äºå®ƒæœ¬èº«é˜Ÿåˆ—çš„secondary _msgï¼Œæ­¤æ—¶å°±ä¼šæœ‰ä¸€ä¸ªsecondary_msgåŒæ—¶è¢«ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ï¼Œç”±æ­¤é€ æˆuafã€‚

ä¸ºç»§ç»­åˆ©ç”¨ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å“ªä¸¤ä¸ª`primary_msg`æŒ‡é’ˆæŒ‡å‘äº†åŒä¸€ä¸ª`secondary_msg`.ç”±äºåœ¨å‘é€`msg`æ—¶æå‰å°†æ ‡å·æ”¾å…¥`msg`çš„å†…å®¹ä¸­ï¼Œå¯ä»¥ä½¿ç”¨`msgrcv()`è·å–`secondary_msg` ï¼Œè¿™æ—¶çš„è·å–é€šè¿‡`primary_msg`çš„`struct msg_msg-&gt;m_list`è·å–ï¼Œè¢«ä¿®æ”¹çš„`msg`ä¼šæŒ‡å‘idä¸æ¶ˆæ¯é˜Ÿåˆ—idä¸åŒçš„`secondary_msg`,è¿™æ—¶å¯ä»¥é€šè¿‡å½“å‰æ¶ˆæ¯é˜Ÿåˆ—çš„idä¸`secondary_msg`çš„idè·å–å…·ä½“å“ªä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ª`msg`ã€‚



## SMAP

smapé˜»æ­¢å†…æ ¸ç›´æ¥è®¿é—®ç”¨æˆ·ç©ºé—´çš„å†…å®¹ï¼Œè¿™ä½¿æ³„éœ²å†…æ ¸çš„åœ°å€ä¼šæ›´å¤æ‚ã€‚

å…ˆå°†è¢«åŒé‡æŒ‡é’ˆæŒ‡å‘çš„åœ°å€freeæ‰ï¼Œåˆ›å»ºä¸€ä¸ªfakemsgå†…å®¹å¦‚ä¸‹ï¼š

```
build_msg_msg((void *)secondary_buf, 0x41414141, 0x42424242,
                PAGE_SIZE - MSG_MSG_SIZE, 0);
```

é‡‡ç”¨å¥—æ¥å­—å°†fakemsgæ”¾åˆ°å¯ä»¥è¢«uafçš„åœ°æ–¹ï¼Œ

```
int spray_skbuff(int ss[NUM_SOCKETS][2], const void *buf, size_t size) `{`
  for (int i = 0; i &lt; NUM_SOCKETS; i++) `{`
    for (int j = 0; j &lt; NUM_SKBUFFS; j++) `{`
      if (write(ss[i][0], buf, size) &lt; 0) `{`
        perror("[-] write");
        return -1;
      `}`
    `}`
  `}`
  return 0;
`}`
//åŸç† ssæ˜¯ç”± socketpairåˆ¶é€ ä¸€å¯¹ç›¸äº’è¿æ¥çš„å¥—æ¥å­—
```

æ”¹å˜äº†fakemasgçš„m_tsä½ç½®ï¼Œå³æ‰©å¤§äº†è¯»å–èŒƒå›´ï¼Œå¯ä»¥é€šè¿‡æŒ‡é’ˆè·å–åˆ°

```
msg = (struct msg_msg *)&amp;msg_fake.mtext[SECONDARY_SIZE - MSG_MSG_SIZE];
  //è·å–ç›¸é‚»msg
```

fakechunkçš„ç›¸é‚»çš„chunkä¿¡æ¯ï¼Œé€šè¿‡è¯¥chunkæ‰¾åˆ° å¯¹åº”primaryåœ°å€ï¼Œä»¥æ­¤æ„é€ ä¸€ä¸ªåˆæ³•çš„msg ï¼Œå°†ä»–freeæ‰ã€‚æ­¤æ—¶ss[i][1]äº§ç”Ÿçš„æŒ‡é’ˆæŒ‡å‘è¯¥åœ°å€ã€‚

è¿™äº›å¯¹äºmsgçš„æ“ä½œæ˜¯ä¸ºäº†æ›´ç®€ä¾¿åœ°uafæ”»å‡»ã€‚



## æ”»å‡»å†…æ ¸è·¯å¾„ã€‚

è®¡ç®—å†…æ ¸åœ°å€ï¼Œé‡‡ç”¨`pipe()`å¯¹åº”ç»“æ„ä½“,é€šè¿‡è°ƒç”¨`pipe()`å¯ä»¥åˆ†é…åˆ°`pipe_buffer`

åˆ›å»ºpipe

```
struct pipe_buffer `{`
    struct page *page;
    unsigned int offset, len;
    const struct pipe_buf_operations *ops;
    unsigned int flags;
    unsigned long private;
`}`;
```

å…¶ä¸­æœ‰`const struct pipe_buf_operations *ops;`

```
struct pipe_buf_operations `{`
    int (*confirm)(struct pipe_inode_info *, struct pipe_buffer *);
    void (*release)(struct pipe_inode_info *, struct pipe_buffer *);
    bool (*try_steal)(struct pipe_inode_info *, struct pipe_buffer *);
    bool (*get)(struct pipe_inode_info *, struct pipe_buffer *);
`}`;
```

ä¸€æ—¦æœ‰pipeè¢«å†™å…¥`struct pipe_buffer`å°±ä¼šè¢«å†™å…¥å†…å®¹ï¼Œç”±äºå…¶ä¸­ `ops`ä¼šå®šä½åˆ°`.data`æ®µã€‚æ³„éœ²è¯¥åœ°å€ï¼Œç”±äºåç§»å›ºå®šï¼Œå¾ˆå®¹æ˜“å¯ä»¥è®¡ç®—å‡ºå†…æ ¸åŸºåœ°å€ã€‚



## åˆ›å»ºæ”»å‡»å†…æ ¸çš„ropé“¾

é€šè¿‡uafè¦†ç›–ä¿®æ”¹pipeã€‚å°†å¯¹åº”releaseå‡½æ•°çš„åœ°å€ä¼ªé€ æˆropé“¾ã€‚

ropé“¾éœ€è¦å®Œæˆæ›´æ”¹credsï¼ˆèº«ä»½ä¿¡æ¯ï¼‰ï¼Œ`commit_creds(prepare_kernel_cred(NULL))`å¹¶ä¸”è¿”å›å‘½åç©ºé—´ `switch_task_namespaces(find_task_by_vpid(1), init_nsproxy)`ã€‚

ç”±æ­¤ææƒ



## è°ƒç”¨ropé“¾

ä¸Šé¢æåˆ°å·²ç»è®¡ç®—å‡ºå†…æ ¸åŸºå€ï¼Œå› æ­¤åˆ›å»ºä¸€ä¸ªfakepipebufferï¼Œä¼ªé€ opsï¼Œæ›´æ”¹opsä¸­realeseçš„æŒ‡å‘ä¸ºå¯¹åº”ropçš„èµ·å§‹åœ°å€ã€‚åœ¨å…³é—­pipeæ—¶è°ƒç”¨åˆ°realeseã€‚å®é™…åŠ«æŒæµç¨‹æ‰§è¡Œææƒropã€‚

<a class="reference-link" name="%E6%9C%80%E5%90%8E%E5%90%AF%E5%8A%A8shell%20%E4%B8%BAroot%E6%9D%83%E9%99%90%E3%80%82"></a>æœ€åå¯åŠ¨shell ä¸ºrootæƒé™ã€‚



## å®éªŒæ¼”ç¤º

[![](https://p3.ssl.qhimg.com/t010630e30efdb47c68.png)](https://p3.ssl.qhimg.com/t010630e30efdb47c68.png)

dockeræœ¬åœ°æ­å»º

å†…æ ¸å°ç™½ï¼Œå¦‚æœç†è§£ä¸Šæœ‰åå·®ï¼Œè¯·æŒ‡æ­£ğŸ™



## å‚è€ƒèµ„æ–™

â€“[https://switch-router.gitee.io/blog/netfilter4/](https://switch-router.gitee.io/blog/netfilter4/)

â€“[https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html#proof-of-concept](https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html#proof-of-concept)

â€“[https://blog.csdn.net/weixin_40039738/article/details/81095013](https://blog.csdn.net/weixin_40039738/article/details/81095013)

â€“[https://www.cnblogs.com/52php/p/5862114.html](https://www.cnblogs.com/52php/p/5862114.html)
